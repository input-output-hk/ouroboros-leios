name: "conformance-linear"

env:
  ALLOWED_URIS: "https://github.com https://api.github.com"
  TRUSTED_PUBLIC_KEYS: "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ="
  SUBSTITUTERS: "https://cache.nixos.org/ https://cache.iog.io"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

on:
  pull_request:
    paths:
      - "leios-trace-hs/**"
      - "leios-trace-verifier/**"
  push:
    branches:
      - main
    paths:
      - "leios-trace-hs/**"
      - "leios-trace-verifier/**"

jobs:
  linear-trace-verifier:
    name: Linear Leios trace verifier
    runs-on: ubuntu-latest
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v4
    - name: üõ†Ô∏è Install Nix
      uses: cachix/install-nix-action@v21
      with:
        nix_path: nixpkgs=channel:nixos-24.05
        install_url: https://releases.nixos.org/nix/nix-2.28.3/install
        extra_nix_config: |
          allowed-uris = ${{ env.ALLOWED_URIS }}
          trusted-public-keys = ${{ env.TRUSTED_PUBLIC_KEYS }}
          substituters = ${{ env.SUBSTITUTERS }}
          experimental-features = nix-command flakes
          accept-flake-config = true
    - name: üèóÔ∏è Build trace verifier
      run: |
        nix build --show-trace .#linear-leios-trace-verifier
    - uses: actions/checkout@v4
    - uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: "1.88.0"
        cache-workspaces: sim-rs
    - name: Generate example trace
      working-directory: sim-rs
      run: |
        cargo run --release -- \
          --conformance-events \
          --slots 3600 \
          --parameters parameters/linear-with-tx-references.yaml \
          test_data/small.yaml \
          output/sim.log \
    - name: üî¨ Check example trace
      run: |
        nix run .#linear-leios-trace-verifier -- \
          --config-file sim-rs/parameters/linear.yaml \
          --topology-file sim-rs/test_data/small.yaml \
          --trace-file sim-rs/output/sim.log \
          --idSut 0 \
        || true   # FIXME: Remove when simulations conform to spec.
