name: "formal-spec-integration"

on:
  workflow_run:
    workflows: ["formal-spec"]
    types:
      - completed
    branches:
      - main

jobs:
  integrate-formal-spec:
    name: "Integrate Formal Spec"
    runs-on: ubuntu-22.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: 📥 Checkout Leios site
        uses: actions/checkout@v4
        with:
          repository: input-output-hk/ouroboros-leios
          token: ${{ secrets.GH_PAT }}

      - name: 📥 Download formal spec HTML
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: formal-spec.yaml
          name: formal-spec-html
          repo: input-output-hk/ouroboros-leios-formal-spec
          token: ${{ secrets.GH_PAT }}

      - name: 🏗️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "yarn"
          cache-dependency-path: ./site/yarn.lock

      - name: 📦 Install dependencies
        working-directory: site
        run: yarn install

      - name: 📝 Update formal spec
        run: |
          # Create formal spec directory if it doesn't exist
          mkdir -p site/static/formal-spec
          # Copy the HTML files
          cp -r formal-spec-html/* site/static/formal-spec/

      - name: 🔄 Enhance Agda documentation
        working-directory: site
        run: |
          # Process HTML files using the agda-web-docs-lib
          NODE_OPTIONS="--max-old-space-size=16384" npx agda-web-docs-lib process ./static/formal-spec ./agda-docs.config.json

      - name: 🏗️ Build Docusaurus site
        working-directory: site
        run: |
          yarn build

      - name: 🚀 Publish GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site/build
          cname: leios.cardano-scaling.org 