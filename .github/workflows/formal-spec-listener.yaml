name: "Formal Spec Flake Input Updater"

on:
  repository_dispatch:
    types: [formal-spec-updated]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA from formal-spec repo to pin to'
        required: true
        type: string

jobs:
  update-flake-input:
    name: "Update Formal Spec Flake Input"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN || github.token }}

      - name: ðŸ”§ Setup Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: ðŸ“ Extract commit SHA
        id: extract-sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_SHA="${{ inputs.commit_sha }}"
          else
            COMMIT_SHA="${{ github.event.client_payload.sha }}"
          fi

          if [ -z "$COMMIT_SHA" ]; then
            echo "Error: No commit SHA provided"
            exit 1
          fi

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Updating to commit: $COMMIT_SHA"

      - name: ðŸ”„ Update flake input
        run: |
          # Update the flake.nix file to pin to new commit
          sed -i 's|leios-spec.url = "github:input-output-hk/ouroboros-leios-formal-spec?rev=[^"]*"|leios-spec.url = "github:input-output-hk/ouroboros-leios-formal-spec?rev=${{ steps.extract-sha.outputs.commit_sha }}"|' flake.nix

          # Update flake.lock
          nix flake update leios-spec

          # Show what changed
          git diff flake.nix flake.lock

      - name: ðŸ” Check for changes
        id: check-changes
        run: |
          git add flake.nix flake.lock
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in flake inputs"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git commit -m "Update formal-spec flake input to ${{ steps.extract-sha.outputs.commit_sha }}

          - Updated from ouroboros-leios-formal-spec repository
          - Commit: ${{ steps.extract-sha.outputs.commit_sha }}
          - Triggered by: ${{ github.event_name }}"
          git push
