name: "Formal Spec Listener"

on:
  repository_dispatch:
    types: [formal-spec-updated]
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  download-artifacts:
    name: "Download Formal Spec Artifacts"
    runs-on: ubuntu-latest
    outputs:
      artifacts-available: ${{ steps.check-artifacts.outputs.available }}
      download-successful: ${{ steps.validate-download.outputs.successful }}
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔍 List available artifacts in formal-spec repo
        id: list_artifacts
        run: |
          echo "Checking for artifacts in formal-spec repo..."
          echo "Event payload: ${{ toJSON(github.event.client_payload) }}"

          ARTIFACTS=$(curl -s -H "Authorization: token ${{ secrets.LEIOS_TRIGGER_PAT }}" \
            "https://api.github.com/repos/input-output-hk/ouroboros-leios-formal-spec/actions/artifacts")

          echo "Available artifacts:"
          echo "$ARTIFACTS" | jq '.artifacts[] | {name: .name, id: .id, created_at: .created_at, expired: .expired, workflow_run: .workflow_run.id}' || true

          # Find the most recent formal-spec-html artifact ID
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq -r '.artifacts[] | select(.name=="formal-spec-html" and .expired==false) | .id' | head -n 1)

          if [ -n "$ARTIFACT_ID" ]; then
            echo "Found formal-spec-html artifact with ID: $ARTIFACT_ID"
            echo "artifact_id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
          else
            echo "No valid formal-spec-html artifact found"
          fi

      - name: 📥 Download formal spec HTML by run ID
        id: download_by_run
        if: github.event.client_payload.run_id != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: formal-spec-html
          repository: input-output-hk/ouroboros-leios-formal-spec
          run-id: ${{ github.event.client_payload.run_id }}
          path: formal-spec-html
          github-token: ${{ secrets.LEIOS_TRIGGER_PAT }}

      - name: 📥 Download formal spec HTML by artifact ID (fallback)
        id: download_by_id
        if: steps.download_by_run.outcome != 'success' && steps.list_artifacts.outputs.artifact_id != ''
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          name: formal-spec-html
          repo: input-output-hk/ouroboros-leios-formal-spec
          workflow: formal-spec.yaml
          path: formal-spec-html
          github_token: ${{ secrets.LEIOS_TRIGGER_PAT }}
          search_artifacts: true
          if_no_artifact_found: warn

      - name: ✅ Validate download and create placeholder if needed
        id: validate-download
        run: |
          mkdir -p formal-spec-html

          # Check if we successfully downloaded files
          if [ -n "$(ls -A formal-spec-html 2>/dev/null)" ]; then
            echo "Using downloaded formal spec HTML"
            echo "Files in formal-spec-html directory:"
            ls -la formal-spec-html/
            echo "successful=true" >> $GITHUB_OUTPUT
          else
            echo "No formal spec HTML available, creating placeholder"
            echo "<html><body><h1>Formal Specification</h1><p>Formal specification documentation is being updated. Please check back later.</p></body></html>" > formal-spec-html/index.html
            echo "successful=false" >> $GITHUB_OUTPUT
          fi

      - name: 🔍 Check artifacts availability
        id: check-artifacts
        run: |
          if [ -d "formal-spec-html" ] && [ -n "$(ls -A formal-spec-html/ 2>/dev/null)" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: 📤 Upload artifacts for next job
        uses: actions/upload-artifact@v4
        with:
          name: formal-spec-html-processed
          path: formal-spec-html/
          retention-days: 1

  process-documentation:
    name: "Process and Enhance Documentation"
    runs-on: ubuntu-latest
    needs: download-artifacts
    if: needs.download-artifacts.outputs.artifacts-available == 'true'
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download artifacts from previous job
        uses: actions/download-artifact@v4
        with:
          name: formal-spec-html-processed
          path: formal-spec-html

      - name: 🛠️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "yarn"
          cache-dependency-path: ./site/yarn.lock

      - name: 📦 Install dependencies
        working-directory: site
        run: yarn install

      - name: 📝 Prepare formal spec directory
        run: |
          mkdir -p site/static/formal-spec
          # Clear existing formal spec files
          rm -rf site/static/formal-spec/*

          if [ -d "formal-spec-html" ] && [ -n "$(ls -A formal-spec-html/ 2>/dev/null)" ]; then
            cp -r formal-spec-html/* site/static/formal-spec/
          fi

      - name: 🔄 Enhance Agda documentation
        working-directory: site
        timeout-minutes: 25
        run: |
          HTML_COUNT=$(find ./static/formal-spec -name '*.html' | wc -l)
          if [ "$HTML_COUNT" -gt "0" ]; then
            NODE_OPTIONS="--max-old-space-size=4096" npx agda-web-docs-lib process ./static/formal-spec ./agda-docs.config.json
          fi

      - name: 📤 Upload processed documentation
        uses: actions/upload-artifact@v4
        with:
          name: enhanced-formal-spec
          path: site/static/formal-spec/
          retention-days: 1

  deploy:
    name: "Deploy to GitHub Pages"
    runs-on: ubuntu-latest
    needs: [download-artifacts, process-documentation]
    if: always() && (needs.download-artifacts.outputs.artifacts-available == 'true' || needs.download-artifacts.outputs.artifacts-available == 'false')
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download enhanced documentation (if available)
        if: needs.process-documentation.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: enhanced-formal-spec
          path: deploy-content
        continue-on-error: true

      - name: 📥 Download basic artifacts (fallback)
        if: needs.process-documentation.result != 'success'
        uses: actions/download-artifact@v4
        with:
          name: formal-spec-html-processed
          path: deploy-content
        continue-on-error: true

      - name: 🔧 Configure Git for deployment
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global http.postBuffer 52428800
          git config --global core.compression 1

      - name: 🚀 Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN || github.token }}
          publish_dir: deploy-content
          destination_dir: formal-spec
          cname: leios.cardano-scaling.org
          keep_files: true
