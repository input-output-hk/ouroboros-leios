## Leios.Protocol

This module defines the core Leios protocol state machine, including:
- Input/output message types
- Protocol state representation and operations
- Block and transaction validation
- State transition logic for processing headers and block bodies
  The protocol integrates header/body diffusion with the underlying base protocol.
<!--
<pre class="Agda"><a id="362" class="Symbol">{-#</a> <a id="366" class="Keyword">OPTIONS</a> <a id="374" class="Pragma">--safe</a> <a id="381" class="Symbol">#-}</a>
</pre>-->
<pre class="Agda"><a id="401" class="Keyword">open</a> <a id="406" class="Keyword">import</a> <a id="413" href="Leios.Prelude.html" class="Module">Leios.Prelude</a> <a id="427" class="Keyword">hiding</a> <a id="434" class="Symbol">(</a><a id="435" href="Function.Base.html#704" class="Function">id</a><a id="437" class="Symbol">;</a> <a id="439" href="Class.Applicative.Core.html#506" class="Function Operator">_⊗_</a><a id="442" class="Symbol">)</a>
<a id="444" class="Keyword">open</a> <a id="449" class="Keyword">import</a> <a id="456" href="Leios.FFD.html" class="Module">Leios.FFD</a>
<a id="466" class="Keyword">open</a> <a id="471" class="Keyword">import</a> <a id="478" href="Leios.SpecStructure.html" class="Module">Leios.SpecStructure</a>

<a id="499" class="Keyword">module</a> <a id="506" href="Leios.Protocol.html" class="Module">Leios.Protocol</a> <a id="521" class="Symbol">(</a><a id="522" href="Leios.Protocol.html#522" class="Bound">⋯</a> <a id="524" class="Symbol">:</a> <a id="526" href="Leios.SpecStructure.html#348" class="Record">SpecStructure</a><a id="539" class="Symbol">)</a> <a id="541" class="Symbol">(</a><a id="542" class="Keyword">let</a> <a id="546" class="Keyword">open</a> <a id="551" href="Leios.SpecStructure.html#348" class="Module">SpecStructure</a> <a id="565" href="Leios.Protocol.html#522" class="Bound">⋯</a><a id="566" class="Symbol">)</a> <a id="568" class="Symbol">(</a><a id="569" href="Leios.Protocol.html#569" class="Bound">SlotUpkeep</a> <a id="580" class="Symbol">:</a> <a id="582" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="586" class="Symbol">)</a> <a id="588" class="Symbol">(</a><a id="589" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a> <a id="601" class="Symbol">:</a> <a id="603" href="Agda.Primitive.html#388" class="Primitive">Type</a><a id="607" class="Symbol">)</a> <a id="609" class="Keyword">where</a>

<a id="616" class="Keyword">open</a> <a id="621" href="Leios.Base.html#643" class="Module">BaseAbstract</a> <a id="634" href="Leios.SpecStructure.html#856" class="Field">B&#39;</a> <a id="637" class="Keyword">using</a> <a id="643" class="Symbol">(</a><a id="644" href="Leios.Base.html#678" class="Field">Cert</a><a id="648" class="Symbol">;</a> <a id="650" href="Leios.Base.html#744" class="Field">V-chkCerts</a><a id="660" class="Symbol">;</a> <a id="662" href="Leios.Base.html#698" class="Field">VTy</a><a id="665" class="Symbol">;</a> <a id="667" href="Leios.Base.html#717" class="Field">initSlot</a><a id="675" class="Symbol">)</a>
<a id="677" class="Keyword">open</a> <a id="682" href="Leios.Blocks.html#2303" class="Module">GenFFD</a>
</pre>High level structure:
<pre>
                                       Linear Leios
                                       /         |
+-------------------------------------+          |
| Header Diffusion     Body Diffusion |          |
+-------------------------------------+       Base Protocol
                                       \      /
                                       Network
</pre>
<pre class="Agda"><a id="1096" class="Keyword">data</a> <a id="LeiosInput"></a><a id="1101" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a> <a id="1112" class="Symbol">:</a> <a id="1114" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="1119" class="Keyword">where</a>
  <a id="LeiosInput.INIT"></a><a id="1127" href="Leios.Protocol.html#1127" class="InductiveConstructor">INIT</a>     <a id="1136" class="Symbol">:</a> <a id="1138" href="Leios.Base.html#698" class="Function">VTy</a> <a id="1142" class="Symbol">→</a> <a id="1144" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a>
  <a id="LeiosInput.SUBMIT"></a><a id="1157" href="Leios.Protocol.html#1157" class="InductiveConstructor">SUBMIT</a>   <a id="1166" class="Symbol">:</a> <a id="1168" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="1182" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="1184" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1189" href="Leios.Abstract.html#488" class="Function">Tx</a> <a id="1192" class="Symbol">→</a> <a id="1194" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a>
  <a id="LeiosInput.FFD-OUT"></a><a id="1207" href="Leios.Protocol.html#1207" class="InductiveConstructor">FFD-OUT</a>  <a id="1216" class="Symbol">:</a> <a id="1218" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1223" class="Symbol">(</a><a id="1224" href="Leios.FFD.html#176" class="Field">FFDAbstract.Header</a> <a id="1243" href="Leios.Blocks.html#2809" class="Function">ffdAbstract</a> <a id="1255" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="1257" href="Leios.FFD.html#183" class="Field">FFDAbstract.Body</a> <a id="1274" href="Leios.Blocks.html#2809" class="Function">ffdAbstract</a><a id="1285" class="Symbol">)</a> <a id="1287" class="Symbol">→</a> <a id="1289" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a>
  <a id="LeiosInput.SLOT"></a><a id="1302" href="Leios.Protocol.html#1302" class="InductiveConstructor">SLOT</a>     <a id="1311" class="Symbol">:</a> <a id="1313" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a>
  <a id="LeiosInput.FTCH-LDG"></a><a id="1326" href="Leios.Protocol.html#1326" class="InductiveConstructor">FTCH-LDG</a> <a id="1335" class="Symbol">:</a> <a id="1337" href="Leios.Protocol.html#1101" class="Datatype">LeiosInput</a>

<a id="1349" class="Keyword">data</a> <a id="LeiosOutput"></a><a id="1354" href="Leios.Protocol.html#1354" class="Datatype">LeiosOutput</a> <a id="1366" class="Symbol">:</a> <a id="1368" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="1373" class="Keyword">where</a>
  <a id="LeiosOutput.FTCH-LDG"></a><a id="1381" href="Leios.Protocol.html#1381" class="InductiveConstructor">FTCH-LDG</a> <a id="1390" class="Symbol">:</a> <a id="1392" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1397" href="Leios.Abstract.html#488" class="Function">Tx</a> <a id="1400" class="Symbol">→</a> <a id="1402" href="Leios.Protocol.html#1354" class="Datatype">LeiosOutput</a>
  <a id="LeiosOutput.FFD-IN"></a><a id="1416" href="Leios.Protocol.html#1416" class="InductiveConstructor">FFD-IN</a>   <a id="1425" class="Symbol">:</a> <a id="1427" href="Leios.FFD.html#358" class="Datatype">FFDAbstract.Input</a> <a id="1445" href="Leios.Blocks.html#2809" class="Function">ffdAbstract</a> <a id="1457" class="Symbol">→</a> <a id="1459" href="Leios.Protocol.html#1354" class="Datatype">LeiosOutput</a>
  <a id="LeiosOutput.EMPTY"></a><a id="1473" href="Leios.Protocol.html#1473" class="InductiveConstructor">EMPTY</a>    <a id="1482" class="Symbol">:</a> <a id="1484" href="Leios.Protocol.html#1354" class="Datatype">LeiosOutput</a>

<a id="1497" class="Keyword">record</a> <a id="LeiosState"></a><a id="1504" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="1515" class="Symbol">:</a> <a id="1517" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="1522" class="Keyword">where</a>
  <a id="1530" class="Keyword">field</a> <a id="LeiosState.V"></a><a id="1536" href="Leios.Protocol.html#1536" class="Field">V</a>            <a id="1549" class="Symbol">:</a> <a id="1551" href="Leios.Base.html#698" class="Function">VTy</a>
        <a id="LeiosState.SD"></a><a id="1563" href="Leios.Protocol.html#1563" class="Field">SD</a>           <a id="1576" class="Symbol">:</a> <a id="1578" href="Leios.Base.html#467" class="Function">StakeDistr</a>
        <a id="LeiosState.RBs"></a><a id="1597" href="Leios.Protocol.html#1597" class="Field">RBs</a>          <a id="1610" class="Symbol">:</a> <a id="1612" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1617" href="Leios.Base.html#524" class="Record">RankingBlock</a>
        <a id="LeiosState.ToPropose"></a><a id="1638" href="Leios.Protocol.html#1638" class="Field">ToPropose</a>    <a id="1651" class="Symbol">:</a> <a id="1653" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1658" href="Leios.Abstract.html#488" class="Function">Tx</a>
        <a id="1669" class="Comment">{- EBs&#39;: EBs together with the slot in which we received them
        -}</a>
        <a id="LeiosState.EBs&#39;"></a><a id="1750" href="Leios.Protocol.html#1750" class="Field">EBs&#39;</a>         <a id="1763" class="Symbol">:</a> <a id="1765" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1770" class="Symbol">(</a><a id="1771" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a> <a id="1773" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="1775" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a><a id="1788" class="Symbol">)</a>
        <a id="LeiosState.VotedEBs"></a><a id="1798" href="Leios.Protocol.html#1798" class="Field">VotedEBs</a>     <a id="1811" class="Symbol">:</a> <a id="1813" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1818" href="Leios.Abstract.html#632" class="Function">Hash</a>
        <a id="LeiosState.Vs"></a><a id="1831" href="Leios.Protocol.html#1831" class="Field">Vs</a>           <a id="1844" class="Symbol">:</a> <a id="1846" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1851" class="Symbol">(</a><a id="1852" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1857" href="Leios.Abstract.html#680" class="Function">Vote</a><a id="1861" class="Symbol">)</a>
        <a id="LeiosState.slot"></a><a id="1871" href="Leios.Protocol.html#1871" class="Field">slot</a>         <a id="1884" class="Symbol">:</a> <a id="1886" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
        <a id="LeiosState.Upkeep"></a><a id="1896" href="Leios.Protocol.html#1896" class="Field">Upkeep</a>       <a id="1909" class="Symbol">:</a> <a id="1911" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="1916" href="Leios.Protocol.html#569" class="Bound">SlotUpkeep</a>
        <a id="LeiosState.Upkeep-Stage"></a><a id="1935" href="Leios.Protocol.html#1935" class="Field">Upkeep-Stage</a> <a id="1948" class="Symbol">:</a> <a id="1950" href="abstract-set-theory.FiniteSetTheory.html#488" class="Function Operator">ℙ</a> <a id="1952" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a>
        <a id="LeiosState.votingState"></a><a id="1972" href="Leios.Protocol.html#1972" class="Field">votingState</a>  <a id="1985" class="Symbol">:</a> <a id="1987" href="Leios.Voting.html#142" class="Function">VotingState</a>
        <a id="LeiosState.PubKeys"></a><a id="2007" href="Leios.Protocol.html#2007" class="Field">PubKeys</a>      <a id="2020" class="Symbol">:</a> <a id="2022" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2027" href="Leios.VRF.html#909" class="Function">PubKey</a>

  <a id="2037" class="Comment">-- ideally we&#39;d require a non-empty list, but this also works for now</a>
  <a id="LeiosState.currentRB"></a><a id="2109" href="Leios.Protocol.html#2109" class="Function">currentRB</a> <a id="2119" class="Symbol">:</a> <a id="2121" href="Leios.Base.html#524" class="Record">RankingBlock</a>
  <a id="2136" href="Leios.Protocol.html#2109" class="Function">currentRB</a> <a id="2146" class="Symbol">=</a> <a id="2148" href="Data.Maybe.Base.html#1276" class="Function">maybe</a> <a id="2154" class="Symbol">(λ</a> <a id="2157" href="Leios.Protocol.html#2157" class="Bound">x</a> <a id="2159" class="Symbol">→</a> <a id="2161" href="Leios.Protocol.html#2157" class="Bound">x</a><a id="2162" class="Symbol">)</a> <a id="2164" class="Symbol">(</a><a id="2165" class="Keyword">record</a> <a id="2172" class="Symbol">{</a> <a id="2174" href="Leios.Base.html#558" class="Field">txs</a> <a id="2178" class="Symbol">=</a> <a id="2180" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a> <a id="2183" class="Symbol">;</a> <a id="2185" href="Leios.Base.html#580" class="Field">announcedEB</a> <a id="2197" class="Symbol">=</a> <a id="2199" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="2207" class="Symbol">;</a> <a id="2209" href="Leios.Base.html#613" class="Field">ebCert</a> <a id="2216" class="Symbol">=</a> <a id="2218" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="2226" class="Symbol">})</a>
                <a id="2245" class="Symbol">(</a><a id="2246" href="Data.List.Base.html#8143" class="Function">head</a> <a id="2251" href="Leios.Protocol.html#1597" class="Field">RBs</a><a id="2254" class="Symbol">)</a>

  <a id="LeiosState.EBs"></a><a id="2259" href="Leios.Protocol.html#2259" class="Function">EBs</a> <a id="2263" class="Symbol">:</a> <a id="2265" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2270" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a>
  <a id="2286" href="Leios.Protocol.html#2259" class="Function">EBs</a> <a id="2290" class="Symbol">=</a> <a id="2292" href="abstract-set-theory.Prelude.html#1824" class="Function">map</a> <a id="2296" href="Data.Product.Base.html#650" class="Field">proj₂</a> <a id="2302" href="Leios.Protocol.html#1750" class="Field">EBs&#39;</a>

  <a id="LeiosState.lookupEB"></a><a id="2310" href="Leios.Protocol.html#2310" class="Function">lookupEB</a> <a id="2319" class="Symbol">:</a> <a id="2321" href="Leios.Blocks.html#1007" class="Function">EBRef</a> <a id="2327" class="Symbol">→</a> <a id="2329" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="2335" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a>
  <a id="2351" href="Leios.Protocol.html#2310" class="Function">lookupEB</a> <a id="2360" href="Leios.Protocol.html#2360" class="Bound">r</a> <a id="2362" class="Symbol">=</a> <a id="2364" href="Data.List.Base.html#13327" class="Function">find</a> <a id="2369" class="Symbol">(λ</a> <a id="2372" href="Leios.Protocol.html#2372" class="Bound">b</a> <a id="2374" class="Symbol">→</a> <a id="2376" href="Leios.Blocks.html#2173" class="Function">getEBRef</a> <a id="2385" href="Leios.Protocol.html#2372" class="Bound">b</a> <a id="2387" href="Class.DecEq.Core.html#168" class="Field Operator">≟</a> <a id="2389" href="Leios.Protocol.html#2360" class="Bound">r</a><a id="2390" class="Symbol">)</a> <a id="2392" href="Leios.Protocol.html#2259" class="Function">EBs</a>

  <a id="LeiosState.lookupTxs"></a><a id="2399" href="Leios.Protocol.html#2399" class="Function">lookupTxs</a> <a id="2409" class="Symbol">:</a> <a id="2411" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="2425" class="Symbol">→</a> <a id="2427" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2432" href="Leios.Abstract.html#488" class="Function">Tx</a>
  <a id="2437" href="Leios.Protocol.html#2399" class="Function">lookupTxs</a> <a id="2447" href="Leios.Protocol.html#2447" class="Bound">eb</a> <a id="2450" class="Symbol">=</a> <a id="2452" class="Keyword">let</a> <a id="2456" class="Keyword">open</a> <a id="2461" href="Leios.Blocks.html#1059" class="Module">EndorserBlockOSig</a> <a id="2479" href="Leios.Protocol.html#2447" class="Bound">eb</a> <a id="2482" class="Keyword">in</a> <a id="2485" href="Leios.Blocks.html#1189" class="Field">txs</a>

  <a id="LeiosState.lookupTxsC"></a><a id="2492" href="Leios.Protocol.html#2492" class="Function">lookupTxsC</a> <a id="2503" class="Symbol">:</a> <a id="2505" href="Leios.Abstract.html#632" class="Function">Hash</a> <a id="2510" class="Symbol">→</a> <a id="2512" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2517" href="Leios.Abstract.html#488" class="Function">Tx</a>
  <a id="2522" href="Leios.Protocol.html#2492" class="Function">lookupTxsC</a> <a id="2533" href="Leios.Protocol.html#2533" class="Bound">c</a> <a id="2535" class="Symbol">=</a> <a id="2537" href="Data.Maybe.Base.html#1276" class="Function">maybe</a> <a id="2543" href="Leios.Protocol.html#2399" class="Function">lookupTxs</a> <a id="2553" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a> <a id="2556" href="Function.Base.html#1993" class="Function Operator">$</a> <a id="2558" href="Leios.Protocol.html#2310" class="Function">lookupEB</a> <a id="2567" href="Leios.Protocol.html#2533" class="Bound">c</a>

  <a id="LeiosState.Ledger"></a><a id="2572" href="Leios.Protocol.html#2572" class="Function">Ledger</a> <a id="2579" class="Symbol">:</a> <a id="2581" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="2586" href="Leios.Abstract.html#488" class="Function">Tx</a>
  <a id="2591" href="Leios.Protocol.html#2572" class="Function">Ledger</a> <a id="2598" class="Symbol">=</a> <a id="2600" href="Function.Base.html#1657" class="Function">flip</a> <a id="2605" href="Data.List.Base.html#4384" class="Function">L.concatMap</a> <a id="2617" href="Leios.Protocol.html#1597" class="Field">RBs</a>
    <a id="2625" class="Symbol">(λ</a> <a id="2628" href="Leios.Protocol.html#2628" class="Bound">rb</a> <a id="2631" class="Symbol">→</a> <a id="2633" href="Leios.Base.html#558" class="Field">RankingBlock.txs</a> <a id="2650" href="Leios.Protocol.html#2628" class="Bound">rb</a> <a id="2653" href="Data.List.Base.html#1712" class="Function Operator">L.++</a> <a id="2658" href="Data.Maybe.Base.html#1276" class="Function">maybe</a> <a id="2664" href="Leios.Protocol.html#2492" class="Function">lookupTxsC</a> <a id="2675" class="InductiveConstructor">[]</a> <a id="2678" class="Symbol">(</a><a id="2679" href="Leios.Abstract.html#799" class="Function">getEBHash</a> <a id="2689" href="Class.Functor.Core.html#242" class="Field Operator">&lt;$&gt;</a> <a id="2693" class="Symbol">(</a><a id="2694" href="Leios.Base.html#613" class="Field">RankingBlock.ebCert</a> <a id="2714" href="Leios.Protocol.html#2628" class="Bound">rb</a><a id="2716" class="Symbol">)))</a>

  <a id="LeiosState.needsUpkeep"></a><a id="2723" href="Leios.Protocol.html#2723" class="Function">needsUpkeep</a> <a id="2735" class="Symbol">:</a> <a id="2737" href="Leios.Protocol.html#569" class="Bound">SlotUpkeep</a> <a id="2748" class="Symbol">→</a> <a id="2750" href="Agda.Primitive.html#388" class="Primitive">Type</a>
  <a id="2757" href="Leios.Protocol.html#2723" class="Function">needsUpkeep</a> <a id="2769" class="Symbol">=</a> <a id="2771" href="abstract-set-theory.Prelude.html#576" class="Function Operator">_∉ˡ</a> <a id="2775" href="Leios.Protocol.html#1896" class="Field">Upkeep</a>

  <a id="LeiosState.needsUpkeep-Stage"></a><a id="2785" href="Leios.Protocol.html#2785" class="Function">needsUpkeep-Stage</a> <a id="2803" class="Symbol">:</a> <a id="2805" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a> <a id="2817" class="Symbol">→</a> <a id="2819" href="Agda.Primitive.html#388" class="Primitive">Set</a>
  <a id="2825" href="Leios.Protocol.html#2785" class="Function">needsUpkeep-Stage</a> <a id="2843" class="Symbol">=</a> <a id="2845" href="Class.IsSet.html#462" class="Function Operator">_∉</a> <a id="2848" href="Leios.Protocol.html#1935" class="Field">Upkeep-Stage</a>

  <a id="LeiosState.Dec-needsUpkeep-Stage"></a><a id="2864" href="Leios.Protocol.html#2864" class="Function">Dec-needsUpkeep-Stage</a> <a id="2886" class="Symbol">:</a> <a id="2888" class="Symbol">∀</a> <a id="2890" class="Symbol">{</a><a id="2891" href="Leios.Protocol.html#2891" class="Bound">u</a> <a id="2893" class="Symbol">:</a> <a id="2895" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a><a id="2906" class="Symbol">}</a> <a id="2908" class="Symbol">→</a> <a id="2910" class="Symbol">⦃</a> <a id="2912" href="Class.DecEq.Core.html#126" class="Record">DecEq</a> <a id="2918" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a> <a id="2930" class="Symbol">⦄</a> <a id="2932" class="Symbol">→</a> <a id="2934" href="Leios.Protocol.html#2785" class="Function">needsUpkeep-Stage</a> <a id="2952" href="Leios.Protocol.html#2891" class="Bound">u</a> <a id="2954" href="Class.Decidable.Core.html#217" class="Record Operator">⁇</a>
  <a id="2958" href="Leios.Protocol.html#2864" class="Function">Dec-needsUpkeep-Stage</a> <a id="2980" class="Symbol">{</a><a id="2981" href="Leios.Protocol.html#2981" class="Bound">u</a><a id="2982" class="Symbol">}</a> <a id="2984" class="Symbol">.</a><a id="2985" href="Class.Decidable.Core.html#273" class="Field">dec</a> <a id="2989" class="Symbol">=</a> <a id="2991" href="Relation.Nullary.Decidable.Core.html#3277" class="Function">¬?</a> <a id="2994" class="Symbol">(</a><a id="2995" href="Leios.Protocol.html#2981" class="Bound">u</a> <a id="2997" href="Axiom.Set.html#11038" class="Function Operator">∈?</a> <a id="3000" href="Leios.Protocol.html#1935" class="Field">Upkeep-Stage</a><a id="3012" class="Symbol">)</a>

  <a id="3017" class="Comment">-- Produces a Vote certified block</a>
  <a id="LeiosState.ebsWithCert"></a><a id="3054" href="Leios.Protocol.html#3054" class="Function">ebsWithCert</a> <a id="3066" class="Symbol">:</a> <a id="3068" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3073" class="Symbol">(</a><a id="3074" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="3088" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="3090" href="Leios.Abstract.html#656" class="Function">EBCert</a><a id="3096" class="Symbol">)</a>
  <a id="3100" href="Leios.Protocol.html#3054" class="Function">ebsWithCert</a> <a id="3112" class="Symbol">=</a> <a id="3114" href="Data.List.Base.html#4606" class="Function">mapMaybe</a> <a id="3123" href="Leios.Protocol.html#3151" class="Function">getCert</a> <a id="3131" href="Leios.Protocol.html#2259" class="Function">EBs</a>
    <a id="3139" class="Keyword">where</a>
      <a id="3151" href="Leios.Protocol.html#3151" class="Function">getCert</a> <a id="3159" class="Symbol">:</a> <a id="3161" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="3175" class="Symbol">→</a> <a id="3177" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="3183" class="Symbol">(</a><a id="3184" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="3198" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="3200" href="Leios.Abstract.html#656" class="Function">EBCert</a><a id="3206" class="Symbol">)</a>
      <a id="3214" href="Leios.Protocol.html#3151" class="Function">getCert</a> <a id="3222" href="Leios.Protocol.html#3222" class="Bound">eb</a> <a id="3225" class="Symbol">=</a> <a id="3227" href="Function.Base.html#4061" class="Function Operator">case</a> <a id="3232" href="Class.Decidable.Core.html#470" class="Function Operator">¿</a> <a id="3234" href="Leios.Voting.html#211" class="Function">isVoteCertified</a> <a id="3250" href="Leios.Protocol.html#1972" class="Field">votingState</a> <a id="3262" href="Leios.Protocol.html#3222" class="Bound">eb</a> <a id="3265" href="Class.Decidable.Core.html#470" class="Function Operator">¿</a> <a id="3267" href="Function.Base.html#4061" class="Function Operator">of</a> <a id="3270" class="Symbol">λ</a> <a id="3272" class="Keyword">where</a>
        <a id="3286" class="Symbol">(</a><a id="3287" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="3291" href="Leios.Protocol.html#3291" class="Bound">p</a><a id="3292" class="Symbol">)</a> <a id="3294" class="Symbol">→</a> <a id="3296" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="3301" class="Symbol">(</a><a id="3302" href="Leios.Protocol.html#3222" class="Bound">eb</a> <a id="3305" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="3307" href="Leios.SpecStructure.html#1406" class="Field">getEBCert</a> <a id="3317" href="Leios.Protocol.html#3291" class="Bound">p</a><a id="3318" class="Symbol">)</a>
        <a id="3328" class="Symbol">(</a><a id="3329" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="3332" href="Leios.Protocol.html#3332" class="Bound">¬p</a><a id="3334" class="Symbol">)</a> <a id="3336" class="Symbol">→</a> <a id="3338" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a>

<a id="addUpkeep"></a><a id="3347" href="Leios.Protocol.html#3347" class="Function">addUpkeep</a> <a id="3357" class="Symbol">:</a> <a id="3359" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="3370" class="Symbol">→</a> <a id="3372" href="Leios.Protocol.html#569" class="Bound">SlotUpkeep</a> <a id="3383" class="Symbol">→</a> <a id="3385" href="Leios.Protocol.html#1504" class="Record">LeiosState</a>
<a id="3396" href="Leios.Protocol.html#3347" class="Function">addUpkeep</a> <a id="3406" href="Leios.Protocol.html#3406" class="Bound">s</a> <a id="3408" href="Leios.Protocol.html#3408" class="Bound">u</a> <a id="3410" class="Symbol">=</a> <a id="3412" class="Keyword">let</a> <a id="3416" class="Keyword">open</a> <a id="3421" href="Leios.Protocol.html#1504" class="Module">LeiosState</a> <a id="3432" href="Leios.Protocol.html#3406" class="Bound">s</a> <a id="3434" class="Keyword">in</a> <a id="3437" class="Keyword">record</a> <a id="3444" href="Leios.Protocol.html#3406" class="Bound">s</a> <a id="3446" class="Symbol">{</a> <a id="3448" href="Leios.Protocol.html#1896" class="Field">Upkeep</a> <a id="3455" class="Symbol">=</a> <a id="3457" href="Leios.Protocol.html#3408" class="Bound">u</a> <a id="3459" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="3461" href="Leios.Protocol.html#1896" class="Function">Upkeep</a> <a id="3468" class="Symbol">}</a>
<a id="3470" class="Symbol">{-#</a> <a id="3474" class="Keyword">INJECTIVE_FOR_INFERENCE</a> <a id="3498" href="Leios.Protocol.html#3347" class="Function">addUpkeep</a> <a id="3508" class="Symbol">#-}</a>

<a id="addUpkeep-Stage"></a><a id="3513" href="Leios.Protocol.html#3513" class="Function">addUpkeep-Stage</a> <a id="3529" class="Symbol">:</a> <a id="3531" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="3542" class="Symbol">→</a> <a id="3544" href="Leios.Protocol.html#589" class="Bound">StageUpkeep</a> <a id="3556" class="Symbol">→</a> <a id="3558" href="Leios.Protocol.html#1504" class="Record">LeiosState</a>
<a id="3569" href="Leios.Protocol.html#3513" class="Function">addUpkeep-Stage</a> <a id="3585" href="Leios.Protocol.html#3585" class="Bound">s</a> <a id="3587" href="Leios.Protocol.html#3587" class="Bound">u</a> <a id="3589" class="Symbol">=</a> <a id="3591" class="Keyword">let</a> <a id="3595" class="Keyword">open</a> <a id="3600" href="Leios.Protocol.html#1504" class="Module">LeiosState</a> <a id="3611" href="Leios.Protocol.html#3585" class="Bound">s</a> <a id="3613" class="Keyword">in</a> <a id="3616" class="Keyword">record</a> <a id="3623" href="Leios.Protocol.html#3585" class="Bound">s</a> <a id="3625" class="Symbol">{</a> <a id="3627" href="Leios.Protocol.html#1935" class="Field">Upkeep-Stage</a> <a id="3640" class="Symbol">=</a> <a id="3642" href="Leios.Protocol.html#1935" class="Function">Upkeep-Stage</a> <a id="3655" href="Axiom.Set.html#9137" class="Function Operator">∪</a> <a id="3657" href="Class.HasSingleton.html#288" class="Field Operator">❴</a> <a id="3659" href="Leios.Protocol.html#3587" class="Bound">u</a> <a id="3661" href="Class.HasSingleton.html#288" class="Field Operator">❵</a> <a id="3663" class="Symbol">}</a>

<a id="initLeiosState"></a><a id="3666" href="Leios.Protocol.html#3666" class="Function">initLeiosState</a> <a id="3681" class="Symbol">:</a> <a id="3683" href="Leios.Base.html#698" class="Function">VTy</a> <a id="3687" class="Symbol">→</a> <a id="3689" href="Leios.Base.html#467" class="Function">StakeDistr</a> <a id="3700" class="Symbol">→</a> <a id="3702" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="3707" href="Leios.VRF.html#909" class="Function">PubKey</a> <a id="3714" class="Symbol">→</a> <a id="3716" href="Leios.Protocol.html#1504" class="Record">LeiosState</a>
<a id="3727" href="Leios.Protocol.html#3666" class="Function">initLeiosState</a> <a id="3742" href="Leios.Protocol.html#3742" class="Bound">V</a> <a id="3744" href="Leios.Protocol.html#3744" class="Bound">SD</a> <a id="3747" href="Leios.Protocol.html#3747" class="Bound">pks</a> <a id="3751" class="Symbol">=</a> <a id="3753" class="Keyword">record</a>
  <a id="3762" class="Symbol">{</a> <a id="3764" href="Leios.Protocol.html#1536" class="Field">V</a>            <a id="3777" class="Symbol">=</a> <a id="3779" href="Leios.Protocol.html#3742" class="Bound">V</a>
  <a id="3783" class="Symbol">;</a> <a id="3785" href="Leios.Protocol.html#1563" class="Field">SD</a>           <a id="3798" class="Symbol">=</a> <a id="3800" href="Leios.Protocol.html#3744" class="Bound">SD</a>
  <a id="3805" class="Symbol">;</a> <a id="3807" href="Leios.Protocol.html#1597" class="Field">RBs</a>          <a id="3820" class="Symbol">=</a> <a id="3822" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3827" class="Symbol">;</a> <a id="3829" href="Leios.Protocol.html#1638" class="Field">ToPropose</a>    <a id="3842" class="Symbol">=</a> <a id="3844" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3849" class="Symbol">;</a> <a id="3851" href="Leios.Protocol.html#1750" class="Field">EBs&#39;</a>         <a id="3864" class="Symbol">=</a> <a id="3866" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3871" class="Symbol">;</a> <a id="3873" href="Leios.Protocol.html#1798" class="Field">VotedEBs</a>     <a id="3886" class="Symbol">=</a> <a id="3888" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3893" class="Symbol">;</a> <a id="3895" href="Leios.Protocol.html#1831" class="Field">Vs</a>           <a id="3908" class="Symbol">=</a> <a id="3910" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3915" class="Symbol">;</a> <a id="3917" href="Leios.Protocol.html#1871" class="Field">slot</a>         <a id="3930" class="Symbol">=</a> <a id="3932" href="Leios.Base.html#717" class="Function">initSlot</a> <a id="3941" href="Leios.Protocol.html#3742" class="Bound">V</a>
  <a id="3945" class="Symbol">;</a> <a id="3947" href="Leios.Protocol.html#1896" class="Field">Upkeep</a>       <a id="3960" class="Symbol">=</a> <a id="3962" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a>
  <a id="3967" class="Symbol">;</a> <a id="3969" href="Leios.Protocol.html#1935" class="Field">Upkeep-Stage</a> <a id="3982" class="Symbol">=</a> <a id="3984" href="Class.HasEmptySet.html#287" class="Field">∅</a>
  <a id="3988" class="Symbol">;</a> <a id="3990" href="Leios.Protocol.html#1972" class="Field">votingState</a>  <a id="4003" class="Symbol">=</a> <a id="4005" href="Leios.Voting.html#173" class="Function">initVotingState</a>
  <a id="4023" class="Symbol">;</a> <a id="4025" href="Leios.Protocol.html#2007" class="Field">PubKeys</a>      <a id="4038" class="Symbol">=</a> <a id="4040" href="Leios.Protocol.html#3747" class="Bound">pks</a>
  <a id="4046" class="Symbol">}</a>

<a id="stake&#39;"></a><a id="4049" href="Leios.Protocol.html#4049" class="Function">stake&#39;</a> <a id="4056" class="Symbol">:</a> <a id="4058" href="Leios.Abstract.html#512" class="Function">PoolID</a> <a id="4065" class="Symbol">→</a> <a id="4067" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="4078" class="Symbol">→</a> <a id="4080" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="4082" href="Leios.Protocol.html#4049" class="Function">stake&#39;</a> <a id="4089" href="Leios.Protocol.html#4089" class="Bound">pid</a> <a id="4093" class="Keyword">record</a> <a id="4100" class="Symbol">{</a> <a id="4102" href="Leios.Protocol.html#1563" class="Field">SD</a> <a id="4105" class="Symbol">=</a> <a id="4107" href="Leios.Protocol.html#4107" class="Bound">SD</a> <a id="4110" class="Symbol">}</a> <a id="4112" class="Symbol">=</a> <a id="4114" href="Axiom.Set.TotalMap.html#779" class="Function">TotalMap.lookup</a> <a id="4130" href="Leios.Protocol.html#4107" class="Bound">SD</a> <a id="4133" href="Leios.Protocol.html#4089" class="Bound">pid</a>

<a id="stake&#39;&#39;"></a><a id="4138" href="Leios.Protocol.html#4138" class="Function">stake&#39;&#39;</a> <a id="4146" class="Symbol">:</a> <a id="4148" href="Leios.VRF.html#909" class="Function">PubKey</a> <a id="4155" class="Symbol">→</a> <a id="4157" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="4168" class="Symbol">→</a> <a id="4170" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="4172" href="Leios.Protocol.html#4138" class="Function">stake&#39;&#39;</a> <a id="4180" href="Leios.Protocol.html#4180" class="Bound">pk</a> <a id="4183" class="Symbol">=</a> <a id="4185" href="Leios.Protocol.html#4049" class="Function">stake&#39;</a> <a id="4192" class="Symbol">(</a><a id="4193" href="Leios.VRF.html#931" class="Function">poolID</a> <a id="4200" href="Leios.Protocol.html#4180" class="Bound">pk</a><a id="4202" class="Symbol">)</a>

<a id="stake"></a><a id="4205" href="Leios.Protocol.html#4205" class="Function">stake</a> <a id="4211" class="Symbol">:</a> <a id="4213" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="4224" class="Symbol">→</a> <a id="4226" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a>
<a id="4228" href="Leios.Protocol.html#4205" class="Function">stake</a> <a id="4234" class="Symbol">=</a> <a id="4236" href="Leios.Protocol.html#4049" class="Function">stake&#39;</a> <a id="4243" href="Leios.SpecStructure.html#612" class="Field">id</a>

<a id="lookupPubKeyAndStake"></a><a id="4247" href="Leios.Protocol.html#4247" class="Function">lookupPubKeyAndStake</a> <a id="4268" class="Symbol">:</a> <a id="4270" class="Symbol">∀</a> <a id="4272" class="Symbol">{</a><a id="4273" href="Leios.Protocol.html#4273" class="Bound">B</a><a id="4274" class="Symbol">}</a> <a id="4276" class="Symbol">→</a> <a id="4278" class="Symbol">⦃</a> <a id="4280" href="Leios.Protocol.html#4280" class="Bound">_</a> <a id="4282" class="Symbol">:</a> <a id="4284" href="Leios.Blocks.html#589" class="Record">IsBlock</a> <a id="4292" href="Leios.Protocol.html#4273" class="Bound">B</a> <a id="4294" class="Symbol">⦄</a> <a id="4296" class="Symbol">→</a> <a id="4298" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="4309" class="Symbol">→</a> <a id="4311" href="Leios.Protocol.html#4273" class="Bound">B</a> <a id="4313" class="Symbol">→</a> <a id="4315" href="Agda.Builtin.Maybe.html#135" class="Datatype">Maybe</a> <a id="4321" class="Symbol">(</a><a id="4322" href="Leios.VRF.html#909" class="Function">PubKey</a> <a id="4329" href="Data.Product.Base.html#1618" class="Function Operator">×</a> <a id="4331" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="4332" class="Symbol">)</a>
<a id="4334" href="Leios.Protocol.html#4247" class="Function">lookupPubKeyAndStake</a> <a id="4355" href="Leios.Protocol.html#4355" class="Bound">s</a> <a id="4357" href="Leios.Protocol.html#4357" class="Bound">b</a> <a id="4359" class="Symbol">=</a>
  <a id="4363" href="Data.List.Base.html#8143" class="Function">L.head</a> <a id="4370" href="Function.Base.html#1993" class="Function Operator">$</a>
    <a id="4376" href="Data.List.Base.html#1612" class="Function">L.map</a> <a id="4382" class="Symbol">(λ</a> <a id="4385" href="Leios.Protocol.html#4385" class="Bound">pk</a> <a id="4388" class="Symbol">→</a> <a id="4390" class="Symbol">(</a><a id="4391" href="Leios.Protocol.html#4385" class="Bound">pk</a> <a id="4394" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="4396" href="Leios.Protocol.html#4138" class="Function">stake&#39;&#39;</a> <a id="4404" href="Leios.Protocol.html#4385" class="Bound">pk</a> <a id="4407" href="Leios.Protocol.html#4355" class="Bound">s</a><a id="4408" class="Symbol">))</a> <a id="4411" href="Function.Base.html#1993" class="Function Operator">$</a>
      <a id="4419" href="Data.List.Base.html#10389" class="Function">L.filter</a> <a id="4428" class="Symbol">(λ</a> <a id="4431" href="Leios.Protocol.html#4431" class="Bound">pk</a> <a id="4434" class="Symbol">→</a> <a id="4436" href="Leios.Blocks.html#656" class="Field">producerID</a> <a id="4447" href="Leios.Protocol.html#4357" class="Bound">b</a> <a id="4449" href="Class.DecEq.Core.html#168" class="Field Operator">≟</a> <a id="4451" href="Leios.VRF.html#931" class="Function">poolID</a> <a id="4458" href="Leios.Protocol.html#4431" class="Bound">pk</a><a id="4460" class="Symbol">)</a> <a id="4462" class="Symbol">(</a><a id="4463" href="Leios.Protocol.html#2007" class="Field">LeiosState.PubKeys</a> <a id="4482" href="Leios.Protocol.html#4355" class="Bound">s</a><a id="4483" class="Symbol">)</a>

<a id="4486" class="Keyword">module</a> <a id="4493" href="Leios.Protocol.html#4493" class="Module">_</a> <a id="4495" class="Symbol">(</a><a id="4496" href="Leios.Protocol.html#4496" class="Bound">s</a> <a id="4498" class="Symbol">:</a> <a id="4500" href="Leios.Protocol.html#1504" class="Record">LeiosState</a><a id="4510" class="Symbol">)</a>  <a id="4513" class="Keyword">where</a>

  <a id="4522" class="Keyword">record</a> <a id="4529" href="Leios.Protocol.html#4529" class="Record">ebValid</a> <a id="4537" class="Symbol">(</a><a id="4538" href="Leios.Protocol.html#4538" class="Bound">eb</a> <a id="4541" class="Symbol">:</a> <a id="4543" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a><a id="4556" class="Symbol">)</a> <a id="4558" class="Symbol">(</a><a id="4559" href="Leios.Protocol.html#4559" class="Bound">pk</a> <a id="4562" class="Symbol">:</a> <a id="4564" href="Leios.VRF.html#909" class="Function">PubKey</a><a id="4570" class="Symbol">)</a> <a id="4572" class="Symbol">(</a><a id="4573" href="Leios.Protocol.html#4573" class="Bound">st</a> <a id="4576" class="Symbol">:</a> <a id="4578" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="4579" class="Symbol">)</a> <a id="4581" class="Symbol">:</a> <a id="4583" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="4588" class="Keyword">where</a>
    <a id="4598" class="Keyword">field</a> <a id="4604" href="Leios.Protocol.html#4604" class="Field">lotteryPfValid</a> <a id="4619" class="Symbol">:</a> <a id="4621" href="Leios.VRF.html#727" class="Function">verify</a> <a id="4628" href="Leios.Protocol.html#4559" class="Bound">pk</a> <a id="4631" class="Symbol">(</a><a id="4632" href="Leios.Blocks.html#629" class="Field">slotNumber</a> <a id="4643" href="Leios.Protocol.html#4538" class="Bound">eb</a><a id="4645" class="Symbol">)</a> <a id="4647" href="Leios.Protocol.html#4573" class="Bound">st</a> <a id="4650" class="Symbol">(</a><a id="4651" href="Leios.Blocks.html#688" class="Field">lotteryPf</a> <a id="4661" href="Leios.Protocol.html#4538" class="Bound">eb</a><a id="4663" class="Symbol">)</a>
          <a id="4675" href="Leios.Protocol.html#4675" class="Field">signatureValid</a> <a id="4690" class="Symbol">:</a> <a id="4692" href="Leios.VRF.html#964" class="Function">verifySig</a> <a id="4702" href="Leios.Protocol.html#4559" class="Bound">pk</a> <a id="4705" class="Symbol">(</a><a id="4706" href="Leios.Blocks.html#719" class="Field">signature</a> <a id="4716" href="Leios.Protocol.html#4538" class="Bound">eb</a><a id="4718" class="Symbol">)</a>
    <a id="4724" class="Comment">-- TODO</a>
    <a id="4736" class="Comment">-- ibRefsValid : ?</a>
    <a id="4759" class="Comment">-- ebRefsValid : ?</a>

  <a id="4781" href="Leios.Protocol.html#4781" class="Function">ebValid?</a> <a id="4790" class="Symbol">:</a> <a id="4792" class="Symbol">(</a><a id="4793" href="Leios.Protocol.html#4793" class="Bound">eb</a> <a id="4796" class="Symbol">:</a> <a id="4798" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a><a id="4811" class="Symbol">)</a> <a id="4813" class="Symbol">(</a><a id="4814" href="Leios.Protocol.html#4814" class="Bound">pk</a> <a id="4817" class="Symbol">:</a> <a id="4819" href="Leios.VRF.html#909" class="Function">PubKey</a><a id="4825" class="Symbol">)</a> <a id="4827" class="Symbol">(</a><a id="4828" href="Leios.Protocol.html#4828" class="Bound">st</a> <a id="4831" class="Symbol">:</a> <a id="4833" href="Agda.Builtin.Nat.html#203" class="Datatype">ℕ</a><a id="4834" class="Symbol">)</a> <a id="4836" class="Symbol">→</a> <a id="4838" href="Relation.Nullary.Decidable.Core.html#1966" class="Record">Dec</a> <a id="4842" class="Symbol">(</a><a id="4843" href="Leios.Protocol.html#4529" class="Record">ebValid</a> <a id="4851" href="Leios.Protocol.html#4793" class="Bound">eb</a> <a id="4854" href="Leios.Protocol.html#4814" class="Bound">pk</a> <a id="4857" href="Leios.Protocol.html#4828" class="Bound">st</a><a id="4859" class="Symbol">)</a>
  <a id="4863" href="Leios.Protocol.html#4781" class="Function">ebValid?</a> <a id="4872" href="Leios.Protocol.html#4872" class="Bound">h</a> <a id="4874" href="Leios.Protocol.html#4874" class="Bound">pk</a> <a id="4877" href="Leios.Protocol.html#4877" class="Bound">st</a>
    <a id="4884" class="Keyword">with</a> <a id="4889" href="Leios.VRF.html#780" class="Function">verify?</a> <a id="4897" href="Leios.Protocol.html#4874" class="Bound">pk</a> <a id="4900" class="Symbol">(</a><a id="4901" href="Leios.Blocks.html#629" class="Field">slotNumber</a> <a id="4912" href="Leios.Protocol.html#4872" class="Bound">h</a><a id="4913" class="Symbol">)</a> <a id="4915" href="Leios.Protocol.html#4877" class="Bound">st</a> <a id="4918" class="Symbol">(</a><a id="4919" href="Leios.Blocks.html#688" class="Field">lotteryPf</a> <a id="4929" href="Leios.Protocol.html#4872" class="Bound">h</a><a id="4930" class="Symbol">)</a>
  <a id="4934" class="Symbol">...</a> <a id="4938" class="Symbol">|</a> <a id="4940" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="4943" href="Leios.Protocol.html#4943" class="Bound">¬p</a> <a id="4946" class="Symbol">=</a> <a id="4948" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="4951" class="Symbol">(</a><a id="4952" href="Leios.Protocol.html#4943" class="Bound">¬p</a> <a id="4955" href="Function.Base.html#1134" class="Function Operator">∘</a> <a id="4957" href="Leios.Protocol.html#4604" class="Field">ebValid.lotteryPfValid</a><a id="4979" class="Symbol">)</a>
  <a id="4983" class="Symbol">...</a> <a id="4987" class="Symbol">|</a> <a id="4989" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="4993" href="Leios.Protocol.html#4993" class="Bound">p</a>
    <a id="4999" class="Keyword">with</a> <a id="5004" href="Leios.VRF.html#1004" class="Function">verifySig?</a> <a id="5015" class="Bound">pk</a> <a id="5018" class="Symbol">(</a><a id="5019" href="Leios.Blocks.html#719" class="Field">signature</a> <a id="5029" class="Bound">h</a><a id="5030" class="Symbol">)</a>
  <a id="5034" class="Symbol">...</a> <a id="5038" class="Symbol">|</a> <a id="5040" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="5044" href="Leios.Protocol.html#5044" class="Bound">q</a> <a id="5046" class="Symbol">=</a> <a id="5048" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="5052" class="Symbol">(</a><a id="5053" class="Keyword">record</a> <a id="5060" class="Symbol">{</a> <a id="5062" href="Leios.Protocol.html#4604" class="Field">lotteryPfValid</a> <a id="5077" class="Symbol">=</a> <a id="5079" class="Bound">p</a> <a id="5081" class="Symbol">;</a> <a id="5083" href="Leios.Protocol.html#4675" class="Field">signatureValid</a> <a id="5098" class="Symbol">=</a> <a id="5100" href="Leios.Protocol.html#5044" class="Bound">q</a> <a id="5102" class="Symbol">})</a>
  <a id="5107" class="Symbol">...</a> <a id="5111" class="Symbol">|</a> <a id="5113" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="5116" href="Leios.Protocol.html#5116" class="Bound">¬q</a> <a id="5119" class="Symbol">=</a> <a id="5121" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="5124" class="Symbol">(</a><a id="5125" href="Leios.Protocol.html#5116" class="Bound">¬q</a> <a id="5128" href="Function.Base.html#1134" class="Function Operator">∘</a> <a id="5130" href="Leios.Protocol.html#4675" class="Field">ebValid.signatureValid</a><a id="5152" class="Symbol">)</a>

  <a id="5157" class="Comment">-- TODO</a>
  <a id="5167" class="Keyword">record</a> <a id="5174" href="Leios.Protocol.html#5174" class="Record">vsValid</a> <a id="5182" class="Symbol">(</a><a id="5183" href="Leios.Protocol.html#5183" class="Bound">vs</a> <a id="5186" class="Symbol">:</a> <a id="5188" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5193" href="Leios.Abstract.html#680" class="Function">Vote</a><a id="5197" class="Symbol">)</a> <a id="5199" class="Symbol">:</a> <a id="5201" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="5206" class="Keyword">where</a>

  <a id="5215" href="Leios.Protocol.html#5215" class="Function">vsValid?</a> <a id="5224" class="Symbol">:</a> <a id="5226" class="Symbol">(</a><a id="5227" href="Leios.Protocol.html#5227" class="Bound">vs</a> <a id="5230" class="Symbol">:</a> <a id="5232" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="5237" href="Leios.Abstract.html#680" class="Function">Vote</a><a id="5241" class="Symbol">)</a> <a id="5243" class="Symbol">→</a> <a id="5245" href="Relation.Nullary.Decidable.Core.html#1966" class="Record">Dec</a> <a id="5249" class="Symbol">(</a><a id="5250" href="Leios.Protocol.html#5174" class="Record">vsValid</a> <a id="5258" href="Leios.Protocol.html#5227" class="Bound">vs</a><a id="5260" class="Symbol">)</a>
  <a id="5264" href="Leios.Protocol.html#5215" class="Function">vsValid?</a> <a id="5273" class="Symbol">_</a> <a id="5275" class="Symbol">=</a> <a id="5277" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="5281" class="Keyword">record</a> <a id="5288" class="Symbol">{}</a>

  <a id="5294" href="Leios.Protocol.html#5294" class="Function">headerValid</a> <a id="5306" class="Symbol">:</a> <a id="5308" href="Leios.Blocks.html#2351" class="Datatype">Header</a> <a id="5315" class="Symbol">→</a> <a id="5317" href="Agda.Primitive.html#388" class="Primitive">Type</a>
  <a id="5324" href="Leios.Protocol.html#5294" class="Function">headerValid</a> <a id="5336" class="Symbol">(</a><a id="5337" href="Leios.Blocks.html#2375" class="InductiveConstructor">ebHeader</a> <a id="5346" href="Leios.Protocol.html#5346" class="Bound">h</a><a id="5347" class="Symbol">)</a>
    <a id="5353" class="Keyword">with</a> <a id="5358" href="Leios.Protocol.html#4247" class="Function">lookupPubKeyAndStake</a> <a id="5379" href="Leios.Protocol.html#4496" class="Bound">s</a> <a id="5381" href="Leios.Protocol.html#5346" class="Bound">h</a>
  <a id="5385" class="Symbol">...</a> <a id="5389" class="Symbol">|</a> <a id="5391" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="5396" class="Symbol">(</a><a id="5397" href="Leios.Protocol.html#5397" class="Bound">pk</a> <a id="5400" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5402" href="Leios.Protocol.html#5402" class="Bound">pid</a><a id="5405" class="Symbol">)</a> <a id="5407" class="Symbol">=</a> <a id="5409" href="Leios.Protocol.html#4529" class="Record">ebValid</a> <a id="5417" class="Bound">h</a> <a id="5419" href="Leios.Protocol.html#5397" class="Bound">pk</a> <a id="5422" class="Symbol">(</a><a id="5423" href="Leios.Protocol.html#4138" class="Function">stake&#39;&#39;</a> <a id="5431" href="Leios.Protocol.html#5397" class="Bound">pk</a> <a id="5434" href="Leios.Protocol.html#4496" class="Bound">s</a><a id="5435" class="Symbol">)</a>
  <a id="5439" class="Symbol">...</a> <a id="5443" class="Symbol">|</a> <a id="5445" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="5453" class="Symbol">=</a> <a id="5455" href="Data.Empty.html#914" class="Function">⊥</a>
  <a id="5459" href="Leios.Protocol.html#5294" class="Function">headerValid</a> <a id="5471" class="Symbol">(</a><a id="5472" href="Leios.Blocks.html#2413" class="InductiveConstructor">vtHeader</a> <a id="5481" href="Leios.Protocol.html#5481" class="Bound">h</a><a id="5482" class="Symbol">)</a> <a id="5484" class="Symbol">=</a> <a id="5486" href="Leios.Protocol.html#5174" class="Record">vsValid</a> <a id="5494" href="Leios.Protocol.html#5481" class="Bound">h</a>

  <a id="5499" href="Leios.Protocol.html#5499" class="Function">headerValid?</a> <a id="5512" class="Symbol">:</a> <a id="5514" class="Symbol">(</a><a id="5515" href="Leios.Protocol.html#5515" class="Bound">h</a> <a id="5517" class="Symbol">:</a> <a id="5519" href="Leios.Blocks.html#2351" class="Datatype">Header</a><a id="5525" class="Symbol">)</a> <a id="5527" class="Symbol">→</a> <a id="5529" href="Relation.Nullary.Decidable.Core.html#1966" class="Record">Dec</a> <a id="5533" class="Symbol">(</a><a id="5534" href="Leios.Protocol.html#5294" class="Function">headerValid</a> <a id="5546" href="Leios.Protocol.html#5515" class="Bound">h</a><a id="5547" class="Symbol">)</a>
  <a id="5551" href="Leios.Protocol.html#5499" class="Function">headerValid?</a> <a id="5564" class="Symbol">(</a><a id="5565" href="Leios.Blocks.html#2375" class="InductiveConstructor">ebHeader</a> <a id="5574" href="Leios.Protocol.html#5574" class="Bound">h</a><a id="5575" class="Symbol">)</a>
    <a id="5581" class="Keyword">with</a> <a id="5586" href="Leios.Protocol.html#4247" class="Function">lookupPubKeyAndStake</a> <a id="5607" href="Leios.Protocol.html#4496" class="Bound">s</a> <a id="5609" href="Leios.Protocol.html#5574" class="Bound">h</a>
  <a id="5613" class="Symbol">...</a> <a id="5617" class="Symbol">|</a> <a id="5619" href="Agda.Builtin.Maybe.html#173" class="InductiveConstructor">just</a> <a id="5624" class="Symbol">(</a><a id="5625" href="Leios.Protocol.html#5625" class="Bound">pk</a> <a id="5628" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="5630" href="Leios.Protocol.html#5630" class="Bound">pid</a><a id="5633" class="Symbol">)</a> <a id="5635" class="Symbol">=</a> <a id="5637" href="Leios.Protocol.html#4781" class="Function">ebValid?</a> <a id="5646" class="Bound">h</a> <a id="5648" href="Leios.Protocol.html#5625" class="Bound">pk</a> <a id="5651" class="Symbol">(</a><a id="5652" href="Leios.Protocol.html#4138" class="Function">stake&#39;&#39;</a> <a id="5660" href="Leios.Protocol.html#5625" class="Bound">pk</a> <a id="5663" href="Leios.Protocol.html#4496" class="Bound">s</a><a id="5664" class="Symbol">)</a>
  <a id="5668" class="Symbol">...</a> <a id="5672" class="Symbol">|</a> <a id="5674" href="Agda.Builtin.Maybe.html#194" class="InductiveConstructor">nothing</a> <a id="5682" class="Symbol">=</a> <a id="5684" href="Relation.Nullary.Decidable.Core.html#2136" class="InductiveConstructor">no</a> <a id="5687" class="Symbol">λ</a> <a id="5689" href="Leios.Protocol.html#5689" class="Bound">x</a> <a id="5691" class="Symbol">→</a> <a id="5693" href="Leios.Protocol.html#5689" class="Bound">x</a>
  <a id="5697" href="Leios.Protocol.html#5499" class="Function">headerValid?</a> <a id="5710" class="Symbol">(</a><a id="5711" href="Leios.Blocks.html#2413" class="InductiveConstructor">vtHeader</a> <a id="5720" href="Leios.Protocol.html#5720" class="Bound">h</a><a id="5721" class="Symbol">)</a> <a id="5723" class="Symbol">=</a> <a id="5725" href="Leios.Protocol.html#5215" class="Function">vsValid?</a> <a id="5734" href="Leios.Protocol.html#5720" class="Bound">h</a>

  <a id="5739" href="Leios.Protocol.html#5739" class="Function">bodyValid</a> <a id="5749" class="Symbol">:</a> <a id="5751" href="Leios.Blocks.html#2446" class="Function">Body</a> <a id="5756" class="Symbol">→</a> <a id="5758" href="Agda.Primitive.html#388" class="Primitive">Type</a>
  <a id="5765" href="Leios.Protocol.html#5739" class="Function">bodyValid</a> <a id="5775" class="Symbol">_</a> <a id="5777" class="Symbol">=</a> <a id="5779" href="Agda.Builtin.Unit.html#175" class="Record">⊤</a>

  <a id="5784" href="Leios.Protocol.html#5784" class="Function">bodyValid?</a> <a id="5795" class="Symbol">:</a> <a id="5797" class="Symbol">(</a><a id="5798" href="Leios.Protocol.html#5798" class="Bound">b</a> <a id="5800" class="Symbol">:</a> <a id="5802" href="Leios.Blocks.html#2446" class="Function">Body</a><a id="5806" class="Symbol">)</a> <a id="5808" class="Symbol">→</a> <a id="5810" href="Relation.Nullary.Decidable.Core.html#1966" class="Record">Dec</a> <a id="5814" class="Symbol">(</a><a id="5815" href="Leios.Protocol.html#5739" class="Function">bodyValid</a> <a id="5825" href="Leios.Protocol.html#5798" class="Bound">b</a><a id="5826" class="Symbol">)</a>
  <a id="5830" href="Leios.Protocol.html#5784" class="Function">bodyValid?</a> <a id="5841" class="Symbol">_</a> <a id="5843" class="Symbol">=</a> <a id="5845" href="Relation.Nullary.Decidable.Core.html#2099" class="InductiveConstructor">yes</a> <a id="5849" href="Agda.Builtin.Unit.html#212" class="InductiveConstructor">tt</a>

  <a id="5855" class="Keyword">opaque</a>
    <a id="5866" href="Leios.Protocol.html#5866" class="Function">isValid</a> <a id="5874" class="Symbol">:</a> <a id="5876" href="Leios.Blocks.html#2351" class="Datatype">Header</a> <a id="5883" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="5885" href="Leios.Blocks.html#2446" class="Function">Body</a> <a id="5890" class="Symbol">→</a> <a id="5892" href="Agda.Primitive.html#388" class="Primitive">Type</a>
    <a id="5901" href="Leios.Protocol.html#5866" class="Function">isValid</a> <a id="5909" class="Symbol">(</a><a id="5910" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="5915" href="Leios.Protocol.html#5915" class="Bound">h</a><a id="5916" class="Symbol">)</a> <a id="5918" class="Symbol">=</a> <a id="5920" href="Leios.Protocol.html#5294" class="Function">headerValid</a> <a id="5932" href="Leios.Protocol.html#5915" class="Bound">h</a>
    <a id="5938" href="Leios.Protocol.html#5866" class="Function">isValid</a> <a id="5946" class="Symbol">(</a><a id="5947" href="Data.Sum.Base.html#700" class="InductiveConstructor">inj₂</a> <a id="5952" href="Leios.Protocol.html#5952" class="Bound">b</a><a id="5953" class="Symbol">)</a> <a id="5955" class="Symbol">=</a> <a id="5957" href="Leios.Protocol.html#5739" class="Function">bodyValid</a> <a id="5967" href="Leios.Protocol.html#5952" class="Bound">b</a>

    <a id="5974" href="Leios.Protocol.html#5974" class="Function">isValid?</a> <a id="5983" class="Symbol">:</a> <a id="5985" class="Symbol">∀</a> <a id="5987" class="Symbol">(</a><a id="5988" href="Leios.Protocol.html#5988" class="Bound">x</a> <a id="5990" class="Symbol">:</a> <a id="5992" href="Leios.Blocks.html#2351" class="Datatype">Header</a> <a id="5999" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="6001" href="Leios.Blocks.html#2446" class="Function">Body</a><a id="6005" class="Symbol">)</a> <a id="6007" class="Symbol">→</a> <a id="6009" href="Relation.Nullary.Decidable.Core.html#1966" class="Record">Dec</a> <a id="6013" class="Symbol">(</a><a id="6014" href="Leios.Protocol.html#5866" class="Function">isValid</a> <a id="6022" href="Leios.Protocol.html#5988" class="Bound">x</a><a id="6023" class="Symbol">)</a>
    <a id="6029" href="Leios.Protocol.html#5974" class="Function">isValid?</a> <a id="6038" class="Symbol">(</a><a id="6039" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="6044" href="Leios.Protocol.html#6044" class="Bound">h</a><a id="6045" class="Symbol">)</a> <a id="6047" class="Symbol">=</a> <a id="6049" href="Leios.Protocol.html#5499" class="Function">headerValid?</a> <a id="6062" href="Leios.Protocol.html#6044" class="Bound">h</a>
    <a id="6068" href="Leios.Protocol.html#5974" class="Function">isValid?</a> <a id="6077" class="Symbol">(</a><a id="6078" href="Data.Sum.Base.html#700" class="InductiveConstructor">inj₂</a> <a id="6083" href="Leios.Protocol.html#6083" class="Bound">b</a><a id="6084" class="Symbol">)</a> <a id="6086" class="Symbol">=</a> <a id="6088" href="Leios.Protocol.html#5784" class="Function">bodyValid?</a> <a id="6099" href="Leios.Protocol.html#6083" class="Bound">b</a>

<a id="6102" class="Keyword">module</a> <a id="6109" href="Leios.Protocol.html#6109" class="Module">_</a> <a id="6111" class="Symbol">(</a><a id="6112" href="Leios.Protocol.html#6112" class="Bound">s</a> <a id="6114" class="Symbol">:</a> <a id="6116" href="Leios.Protocol.html#1504" class="Record">LeiosState</a><a id="6126" class="Symbol">)</a> <a id="6128" class="Keyword">where</a>

  <a id="6137" class="Keyword">open</a> <a id="6142" href="Leios.Protocol.html#1504" class="Module">LeiosState</a> <a id="6153" href="Leios.Protocol.html#6112" class="Bound">s</a>

  <a id="6158" class="Comment">{- Update the LeiosState upon receiving a message (a header or body) -}</a>
  <a id="6232" href="Leios.Protocol.html#6232" class="Function">upd</a> <a id="6236" class="Symbol">:</a> <a id="6238" href="Leios.Blocks.html#2351" class="Datatype">Header</a> <a id="6245" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="6247" href="Leios.Blocks.html#2446" class="Function">Body</a> <a id="6252" class="Symbol">→</a> <a id="6254" href="Leios.Protocol.html#1504" class="Record">LeiosState</a>
  <a id="6267" href="Leios.Protocol.html#6232" class="Function">upd</a> <a id="6271" class="Symbol">(</a><a id="6272" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="6277" class="Symbol">(</a><a id="6278" href="Leios.Blocks.html#2375" class="InductiveConstructor">ebHeader</a> <a id="6287" href="Leios.Protocol.html#6287" class="Bound">eb</a><a id="6289" class="Symbol">))</a> <a id="6292" class="Symbol">=</a> <a id="6294" class="Keyword">record</a> <a id="6301" href="Leios.Protocol.html#6112" class="Bound">s</a> <a id="6303" class="Symbol">{</a> <a id="6305" href="Leios.Protocol.html#1750" class="Field">EBs&#39;</a> <a id="6310" class="Symbol">=</a> <a id="6312" class="Symbol">(</a><a id="6313" href="Leios.Protocol.html#1871" class="Field">slot</a> <a id="6318" href="Agda.Builtin.Sigma.html#235" class="InductiveConstructor Operator">,</a> <a id="6320" href="Leios.Protocol.html#6287" class="Bound">eb</a><a id="6322" class="Symbol">)</a> <a id="6324" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="6326" href="Leios.Protocol.html#1750" class="Field">EBs&#39;</a> <a id="6331" class="Symbol">}</a>
  <a id="6335" href="Leios.Protocol.html#6232" class="Function">upd</a> <a id="6339" class="Symbol">(</a><a id="6340" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="6345" class="Symbol">(</a><a id="6346" href="Leios.Blocks.html#2413" class="InductiveConstructor">vtHeader</a> <a id="6355" href="Leios.Protocol.html#6355" class="Bound">vs</a><a id="6357" class="Symbol">))</a> <a id="6360" class="Symbol">=</a> <a id="6362" class="Keyword">record</a> <a id="6369" href="Leios.Protocol.html#6112" class="Bound">s</a> <a id="6371" class="Symbol">{</a> <a id="6373" href="Leios.Protocol.html#1831" class="Field">Vs</a> <a id="6376" class="Symbol">=</a> <a id="6378" href="Leios.Protocol.html#6355" class="Bound">vs</a> <a id="6381" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="6383" href="Leios.Protocol.html#1831" class="Field">Vs</a> <a id="6386" class="Symbol">}</a>
  <a id="6390" href="Leios.Protocol.html#6232" class="Function">upd</a> <a id="6394" class="Symbol">(</a><a id="6395" href="Data.Sum.Base.html#700" class="InductiveConstructor">inj₂</a> <a id="6400" class="Symbol">_)</a>             <a id="6415" class="Symbol">=</a> <a id="6417" href="Leios.Protocol.html#6112" class="Bound">s</a>

<a id="6420" class="Keyword">module</a> <a id="6427" href="Leios.Protocol.html#6427" class="Module">_</a> <a id="6429" class="Symbol">{</a><a id="6430" href="Leios.Protocol.html#6430" class="Bound">s</a> <a id="6432" href="Leios.Protocol.html#6432" class="Bound">s&#39;</a><a id="6434" class="Symbol">}</a> <a id="6436" class="Keyword">where</a>
  <a id="6444" class="Keyword">open</a> <a id="6449" href="Leios.Protocol.html#1504" class="Module">LeiosState</a> <a id="6460" href="Leios.Protocol.html#6432" class="Bound">s&#39;</a>

  <a id="6466" href="Leios.Protocol.html#6466" class="Function">upd-preserves-Upkeep</a> <a id="6487" class="Symbol">:</a> <a id="6489" class="Symbol">∀</a> <a id="6491" class="Symbol">{</a><a id="6492" href="Leios.Protocol.html#6492" class="Bound">x</a><a id="6493" class="Symbol">}</a> <a id="6495" class="Symbol">→</a> <a id="6497" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6515" href="Leios.Protocol.html#6430" class="Bound">s</a> <a id="6517" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6519" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6537" href="Leios.Protocol.html#6432" class="Bound">s&#39;</a>
                               <a id="6571" class="Symbol">→</a> <a id="6573" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6591" href="Leios.Protocol.html#6430" class="Bound">s</a> <a id="6593" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6595" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6613" class="Symbol">(</a><a id="6614" href="Leios.Protocol.html#6232" class="Function">upd</a> <a id="6618" href="Leios.Protocol.html#6432" class="Bound">s&#39;</a> <a id="6621" href="Leios.Protocol.html#6492" class="Bound">x</a><a id="6622" class="Symbol">)</a>
  <a id="6626" href="Leios.Protocol.html#6466" class="Function">upd-preserves-Upkeep</a> <a id="6647" class="Symbol">{</a><a id="6648" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="6653" class="Symbol">(</a><a id="6654" href="Leios.Blocks.html#2375" class="InductiveConstructor">ebHeader</a> <a id="6663" href="Leios.Protocol.html#6663" class="Bound">x</a><a id="6664" class="Symbol">)}</a> <a id="6667" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="6672" class="Symbol">=</a> <a id="6674" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>
  <a id="6681" href="Leios.Protocol.html#6466" class="Function">upd-preserves-Upkeep</a> <a id="6702" class="Symbol">{</a><a id="6703" href="Data.Sum.Base.html#675" class="InductiveConstructor">inj₁</a> <a id="6708" class="Symbol">(</a><a id="6709" href="Leios.Blocks.html#2413" class="InductiveConstructor">vtHeader</a> <a id="6718" href="Leios.Protocol.html#6718" class="Bound">x</a><a id="6719" class="Symbol">)}</a> <a id="6722" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a> <a id="6727" class="Symbol">=</a> <a id="6729" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>
  <a id="6736" href="Leios.Protocol.html#6466" class="Function">upd-preserves-Upkeep</a> <a id="6757" class="Symbol">{</a><a id="6758" href="Data.Sum.Base.html#700" class="InductiveConstructor">inj₂</a> <a id="6763" class="Symbol">_}</a> <a id="6766" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>            <a id="6782" class="Symbol">=</a> <a id="6784" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>

<a id="6790" class="Keyword">infix</a> <a id="6796" class="Number">25</a> <a id="6799" href="Leios.Protocol.html#6803" class="Function Operator">_↑_</a>
<a id="_↑_"></a><a id="6803" href="Leios.Protocol.html#6803" class="Function Operator">_↑_</a> <a id="6807" class="Symbol">:</a> <a id="6809" href="Leios.Protocol.html#1504" class="Record">LeiosState</a> <a id="6820" class="Symbol">→</a> <a id="6822" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="6827" class="Symbol">(</a><a id="6828" href="Leios.Blocks.html#2351" class="Datatype">Header</a> <a id="6835" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="6837" href="Leios.Blocks.html#2446" class="Function">Body</a><a id="6841" class="Symbol">)</a> <a id="6843" class="Symbol">→</a> <a id="6845" href="Leios.Protocol.html#1504" class="Record">LeiosState</a>
<a id="6856" href="Leios.Protocol.html#6803" class="Function Operator">_↑_</a> <a id="6860" class="Symbol">=</a> <a id="6862" href="Data.List.Base.html#4126" class="Function">foldr</a> <a id="6868" class="Symbol">(</a><a id="6869" href="Function.Base.html#1657" class="Function">flip</a> <a id="6874" href="Leios.Protocol.html#6232" class="Function">upd</a><a id="6877" class="Symbol">)</a>

<a id="↑-preserves-Upkeep"></a><a id="6880" href="Leios.Protocol.html#6880" class="Function">↑-preserves-Upkeep</a> <a id="6899" class="Symbol">:</a> <a id="6901" class="Symbol">∀</a> <a id="6903" class="Symbol">{</a><a id="6904" href="Leios.Protocol.html#6904" class="Bound">s</a> <a id="6906" href="Leios.Protocol.html#6906" class="Bound">x</a><a id="6907" class="Symbol">}</a> <a id="6909" class="Symbol">→</a> <a id="6911" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6929" href="Leios.Protocol.html#6904" class="Bound">s</a> <a id="6931" href="Agda.Builtin.Equality.html#150" class="Datatype Operator">≡</a> <a id="6933" href="Leios.Protocol.html#1896" class="Field">LeiosState.Upkeep</a> <a id="6951" class="Symbol">(</a><a id="6952" href="Leios.Protocol.html#6904" class="Bound">s</a> <a id="6954" href="Leios.Protocol.html#6803" class="Function Operator">↑</a> <a id="6956" href="Leios.Protocol.html#6906" class="Bound">x</a><a id="6957" class="Symbol">)</a>
<a id="6959" href="Leios.Protocol.html#6880" class="Function">↑-preserves-Upkeep</a> <a id="6978" class="Symbol">{</a><a id="6979" class="Argument">x</a> <a id="6981" class="Symbol">=</a> <a id="6983" href="Agda.Builtin.List.html#184" class="InductiveConstructor">[]</a><a id="6985" class="Symbol">}</a> <a id="6987" class="Symbol">=</a> <a id="6989" href="Agda.Builtin.Equality.html#207" class="InductiveConstructor">refl</a>
<a id="6994" href="Leios.Protocol.html#6880" class="Function">↑-preserves-Upkeep</a> <a id="7013" class="Symbol">{</a><a id="7014" class="Argument">s</a> <a id="7016" class="Symbol">=</a> <a id="7018" href="Leios.Protocol.html#7018" class="Bound">s</a><a id="7019" class="Symbol">}</a> <a id="7021" class="Symbol">{</a><a id="7022" class="Argument">x</a> <a id="7024" class="Symbol">=</a> <a id="7026" href="Leios.Protocol.html#7026" class="Bound">x</a> <a id="7028" href="Agda.Builtin.List.html#199" class="InductiveConstructor Operator">∷</a> <a id="7030" href="Leios.Protocol.html#7030" class="Bound">x₁</a><a id="7032" class="Symbol">}</a> <a id="7034" class="Symbol">=</a>
  <a id="7038" href="Leios.Protocol.html#6466" class="Function">upd-preserves-Upkeep</a> <a id="7059" class="Symbol">{</a><a id="7060" class="Argument">s</a> <a id="7062" class="Symbol">=</a> <a id="7064" href="Leios.Protocol.html#7018" class="Bound">s</a><a id="7065" class="Symbol">}</a> <a id="7067" class="Symbol">{</a><a id="7068" class="Argument">x</a> <a id="7070" class="Symbol">=</a> <a id="7072" href="Leios.Protocol.html#7026" class="Bound">x</a><a id="7073" class="Symbol">}</a> <a id="7075" class="Symbol">(</a><a id="7076" href="Leios.Protocol.html#6880" class="Function">↑-preserves-Upkeep</a> <a id="7095" class="Symbol">{</a><a id="7096" class="Argument">x</a> <a id="7098" class="Symbol">=</a> <a id="7100" href="Leios.Protocol.html#7030" class="Bound">x₁</a><a id="7102" class="Symbol">})</a>

<a id="7106" class="Keyword">open</a> <a id="7111" class="Keyword">import</a> <a id="7118" href="Leios.Abstract.html" class="Module">Leios.Abstract</a>

<a id="7134" class="Keyword">open</a> <a id="7139" class="Keyword">import</a> <a id="7146" href="CategoricalCrypto.html" class="Module">CategoricalCrypto</a> <a id="7164" class="Keyword">hiding</a> <a id="7171" class="Symbol">(</a><a id="7172" href="CategoricalCrypto.Machine.Core.html#4922" class="Function Operator">_∘_</a><a id="7175" class="Symbol">)</a>
<a id="7177" class="Keyword">open</a> <a id="7182" class="Keyword">import</a> <a id="7189" href="Leios.Config.html" class="Module">Leios.Config</a>

<a id="7203" class="Keyword">open</a> <a id="7208" class="Keyword">import</a> <a id="7215" href="Network.BasicBroadcast.html" class="Module">Network.BasicBroadcast</a> <a id="7238" class="Keyword">using</a> <a id="7244" class="Symbol">(</a><a id="7245" href="Network.BasicBroadcast.html#220" class="Datatype">NetworkT</a><a id="7253" class="Symbol">;</a> <a id="7255" href="Network.BasicBroadcast.html#251" class="InductiveConstructor">RcvMessage</a><a id="7265" class="Symbol">;</a> <a id="7267" href="Network.BasicBroadcast.html#315" class="InductiveConstructor">SndMessage</a><a id="7277" class="Symbol">;</a> <a id="7279" href="Network.BasicBroadcast.html#288" class="InductiveConstructor">Activate</a><a id="7287" class="Symbol">)</a>

<a id="7290" class="Keyword">module</a> <a id="7297" href="Leios.Protocol.html#7297" class="Module">Types</a> <a id="7303" class="Symbol">(</a><a id="7304" href="Leios.Protocol.html#7304" class="Bound">params</a> <a id="7311" class="Symbol">:</a> <a id="7313" href="Leios.Config.html#778" class="Record">Params</a><a id="7319" class="Symbol">)</a> <a id="7321" class="Symbol">(</a><a id="7322" class="Keyword">let</a> <a id="7326" class="Keyword">open</a> <a id="7331" href="Leios.Config.html#778" class="Module">Params</a> <a id="7338" href="Leios.Protocol.html#7304" class="Bound">params</a><a id="7344" class="Symbol">)</a> <a id="7346" class="Keyword">where</a>

  <a id="7355" href="Leios.Protocol.html#7355" class="Function">Participant</a> <a id="7367" class="Symbol">:</a> <a id="7369" href="Agda.Primitive.html#388" class="Primitive">Type</a>
  <a id="7376" href="Leios.Protocol.html#7355" class="Function">Participant</a> <a id="7388" class="Symbol">=</a> <a id="7390" href="Data.Fin.Base.html#1132" class="Datatype">Fin</a> <a id="7394" href="Leios.Config.html#625" class="Function">numberOfParties</a>

  <a id="7413" href="Leios.Protocol.html#7413" class="Function">NetworkMessage</a> <a id="7428" class="Symbol">:</a> <a id="7430" href="Agda.Primitive.html#388" class="Primitive">Type</a>
  <a id="7437" href="Leios.Protocol.html#7413" class="Function">NetworkMessage</a> <a id="7452" class="Symbol">=</a> <a id="7454" href="Leios.Blocks.html#1236" class="Function">EndorserBlock</a> <a id="7468" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="7470" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="7475" href="Leios.Abstract.html#680" class="Function">Vote</a> <a id="7480" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="7482" href="Leios.Base.html#524" class="Record">RankingBlock</a>

  <a id="7498" href="Leios.Protocol.html#7498" class="Function">Network</a> <a id="7506" class="Symbol">:</a> <a id="7508" href="CategoricalCrypto.Channel.Core.html#717" class="Record">Channel</a>
  <a id="7518" href="Leios.Protocol.html#7498" class="Function">Network</a> <a id="7526" class="Symbol">=</a> <a id="7528" href="CategoricalCrypto.Channel.Core.html#926" class="Function">simpleChannel</a> <a id="7542" class="Symbol">(</a><a id="7543" href="Network.BasicBroadcast.html#220" class="Datatype">NetworkT</a> <a id="7552" href="Leios.Config.html#625" class="Function">numberOfParties</a> <a id="7568" href="Leios.Protocol.html#7413" class="Function">NetworkMessage</a><a id="7582" class="Symbol">)</a>

  <a id="7587" class="Keyword">data</a> <a id="7592" href="Leios.Protocol.html#7592" class="Datatype">IOT</a> <a id="7596" class="Symbol">:</a> <a id="7598" href="CategoricalCrypto.Channel.Core.html#410" class="Datatype">Mode</a> <a id="7603" class="Symbol">→</a> <a id="7605" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="7610" class="Keyword">where</a>
    <a id="7620" href="Leios.Protocol.html#7620" class="InductiveConstructor">SubmitTxs</a> <a id="7630" class="Symbol">:</a> <a id="7632" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="7637" href="Leios.Abstract.html#488" class="Function">Tx</a> <a id="7640" class="Symbol">→</a> <a id="7642" href="Leios.Protocol.html#7592" class="Datatype">IOT</a> <a id="7646" href="CategoricalCrypto.Channel.Core.html#443" class="InductiveConstructor">In</a>
    <a id="7653" href="Leios.Protocol.html#7653" class="InductiveConstructor">FetchLdgI</a> <a id="7663" class="Symbol">:</a> <a id="7665" href="Leios.Protocol.html#7592" class="Datatype">IOT</a> <a id="7669" href="CategoricalCrypto.Channel.Core.html#443" class="InductiveConstructor">In</a>
    <a id="7676" href="Leios.Protocol.html#7676" class="InductiveConstructor">FetchLdgO</a> <a id="7686" class="Symbol">:</a> <a id="7688" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="7693" href="Leios.Abstract.html#488" class="Function">Tx</a> <a id="7696" class="Symbol">→</a> <a id="7698" href="Leios.Protocol.html#7592" class="Datatype">IOT</a> <a id="7702" href="CategoricalCrypto.Channel.Core.html#430" class="InductiveConstructor">Out</a>

  <a id="7709" class="Comment">-- mempool</a>
  <a id="7722" href="Leios.Protocol.html#7722" class="Function">IO</a> <a id="7725" class="Symbol">:</a> <a id="7727" href="CategoricalCrypto.Channel.Core.html#717" class="Record">Channel</a>
  <a id="7737" href="Leios.Protocol.html#7722" class="Function">IO</a> <a id="7740" class="Symbol">=</a> <a id="7742" href="CategoricalCrypto.Channel.Core.html#926" class="Function">simpleChannel</a> <a id="7756" href="Leios.Protocol.html#7592" class="Datatype">IOT</a> <a id="7760" href="CategoricalCrypto.Channel.Core.html#1145" class="Function Operator">ᵀ</a>

  <a id="7765" href="Leios.Protocol.html#7765" class="Function">Adv</a> <a id="7769" class="Symbol">:</a> <a id="7771" href="CategoricalCrypto.Channel.Core.html#717" class="Record">Channel</a>
  <a id="7781" href="Leios.Protocol.html#7765" class="Function">Adv</a> <a id="7785" class="Symbol">=</a> <a id="7787" href="CategoricalCrypto.Channel.Core.html#1122" class="Function">I</a>

  <a id="7792" class="Keyword">module</a> <a id="7799" href="Leios.Protocol.html#7799" class="Module">FFDA</a> <a id="7804" class="Symbol">=</a> <a id="7806" href="Leios.FFD.html#142" class="Module">FFDAbstract</a> <a id="7818" href="Leios.Blocks.html#2809" class="Function">ffdAbstract</a>

  <a id="7833" class="Keyword">data</a> <a id="7838" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="7843" class="Symbol">:</a> <a id="7845" href="CategoricalCrypto.Channel.Core.html#410" class="Datatype">Mode</a> <a id="7850" class="Symbol">→</a> <a id="7852" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="7857" class="Keyword">where</a>
    <a id="7867" href="Leios.Protocol.html#7867" class="InductiveConstructor">FFD-OUT</a> <a id="7875" class="Symbol">:</a> <a id="7877" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="7882" class="Symbol">(</a><a id="7883" href="Leios.FFD.html#176" class="Function">FFDA.Header</a> <a id="7895" href="Data.Sum.Base.html#625" class="Datatype Operator">⊎</a> <a id="7897" href="Leios.FFD.html#183" class="Function">FFDA.Body</a><a id="7906" class="Symbol">)</a> <a id="7908" class="Symbol">→</a> <a id="7910" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="7915" href="CategoricalCrypto.Channel.Core.html#430" class="InductiveConstructor">Out</a>
    <a id="7923" href="Leios.Protocol.html#7923" class="InductiveConstructor">FFD-IN</a>  <a id="7931" class="Symbol">:</a> <a id="7933" href="Leios.FFD.html#358" class="Datatype">FFDA.Input</a> <a id="7944" class="Symbol">→</a> <a id="7946" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="7951" href="CategoricalCrypto.Channel.Core.html#443" class="InductiveConstructor">In</a>
    <a id="7958" href="Leios.Protocol.html#7958" class="InductiveConstructor">SLOT</a>    <a id="7966" class="Symbol">:</a> <a id="7968" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="7973" href="CategoricalCrypto.Channel.Core.html#430" class="InductiveConstructor">Out</a>
    <a id="7981" href="Leios.Protocol.html#7981" class="InductiveConstructor">FTCH</a>    <a id="7989" class="Symbol">:</a> <a id="7991" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="7996" href="CategoricalCrypto.Channel.Core.html#430" class="InductiveConstructor">Out</a>

  <a id="8003" href="Leios.Protocol.html#8003" class="Function">FFD</a> <a id="8007" class="Symbol">:</a> <a id="8009" href="CategoricalCrypto.Channel.Core.html#717" class="Record">Channel</a>
  <a id="8019" href="Leios.Protocol.html#8003" class="Function">FFD</a> <a id="8023" class="Symbol">=</a> <a id="8025" href="CategoricalCrypto.Channel.Core.html#926" class="Function">simpleChannel</a> <a id="8039" href="Leios.Protocol.html#7838" class="Datatype">FFDT</a> <a id="8044" href="CategoricalCrypto.Channel.Core.html#1145" class="Function Operator">ᵀ</a>

  <a id="8049" class="Keyword">data</a> <a id="8054" href="Leios.Protocol.html#8054" class="Datatype">BaseT</a> <a id="8060" class="Symbol">:</a> <a id="8062" href="CategoricalCrypto.Channel.Core.html#410" class="Datatype">Mode</a> <a id="8067" class="Symbol">→</a> <a id="8069" href="Agda.Primitive.html#388" class="Primitive">Type</a> <a id="8074" class="Keyword">where</a>
    <a id="8084" href="Leios.Protocol.html#8084" class="InductiveConstructor">FTCH-LDG</a> <a id="8093" class="Symbol">:</a> <a id="8095" href="Leios.Protocol.html#8054" class="Datatype">BaseT</a> <a id="8101" href="CategoricalCrypto.Channel.Core.html#443" class="InductiveConstructor">In</a>
    <a id="8108" href="Leios.Protocol.html#8108" class="InductiveConstructor">SUBMIT</a>   <a id="8117" class="Symbol">:</a> <a id="8119" href="Leios.Base.html#524" class="Record">RankingBlock</a> <a id="8132" class="Symbol">→</a> <a id="8134" href="Leios.Protocol.html#8054" class="Datatype">BaseT</a> <a id="8140" href="CategoricalCrypto.Channel.Core.html#443" class="InductiveConstructor">In</a>
    <a id="8147" href="Leios.Protocol.html#8147" class="InductiveConstructor">BASE-LDG</a> <a id="8156" class="Symbol">:</a> <a id="8158" href="Agda.Builtin.List.html#147" class="Datatype">List</a> <a id="8163" href="Leios.Base.html#524" class="Record">RankingBlock</a> <a id="8176" class="Symbol">→</a> <a id="8178" href="Leios.Protocol.html#8054" class="Datatype">BaseT</a> <a id="8184" href="CategoricalCrypto.Channel.Core.html#430" class="InductiveConstructor">Out</a>

  <a id="8191" href="Leios.Protocol.html#8191" class="Function">BaseC</a> <a id="8197" class="Symbol">:</a> <a id="8199" href="CategoricalCrypto.Channel.Core.html#717" class="Record">Channel</a>
  <a id="8209" href="Leios.Protocol.html#8191" class="Function">BaseC</a> <a id="8215" class="Symbol">=</a> <a id="8217" href="CategoricalCrypto.Channel.Core.html#926" class="Function">simpleChannel</a> <a id="8231" href="Leios.Protocol.html#8054" class="Datatype">BaseT</a> <a id="8237" href="CategoricalCrypto.Channel.Core.html#1145" class="Function Operator">ᵀ</a>
</pre>