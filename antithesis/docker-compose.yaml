# Leios Antithesis Docker Compose Stack
#
# Two configurations available:
#   1. Proto-devnet (default): 3 block-producing pools with tx-generator
#   2. ImmDB mock (--profile immdb): upstream/node0/downstream with immdb-server
#
# Usage:
#   Default (proto-devnet with 3 pools):
#     docker compose up
#   With immdb-server mock setup:
#     docker compose --profile immdb up
#   With observability stack:
#     docker compose --profile observability up
#   Combined profiles:
#     docker compose --profile immdb --profile observability up
#   With WAN emulation:
#     ENABLE_WAN_EMULATION=true docker compose up

x-common-env: &common-env
  ENABLE_WAN_EMULATION: ${ENABLE_WAN_EMULATION:-false}
  REF_SLOT: ${REF_SLOT:-11}

x-pool-ips: &pool-ips
  IP_POOL1: "172.28.0.10"
  IP_POOL2: "172.28.0.20"
  IP_POOL3: "172.28.0.30"
  PORT_POOL1: "3001"
  PORT_POOL2: "3002"
  PORT_POOL3: "3003"

x-wan-env-upstream: &wan-env-upstream
  RATE: ${RATE_UP_TO_N0:-10Mbps}
  DELAY: ${DELAY_UP_TO_N0:-200ms}

x-wan-env-node0-up: &wan-env-node0-up
  RATE: ${RATE_N0_TO_UP:-10Mbps}
  DELAY: ${DELAY_N0_TO_UP:-200ms}

x-wan-env-node0-down: &wan-env-node0-down
  RATE: ${RATE_N0_TO_DOWN:-10Mbps}
  DELAY: ${DELAY_N0_TO_DOWN:-200ms}

x-wan-env-downstream: &wan-env-downstream
  RATE: ${RATE_DOWN_TO_N0:-10Mbps}
  DELAY: ${DELAY_DOWN_TO_N0:-200ms}

services:
  # ==========================================================================
  # Proto-Devnet: Init Containers
  # ==========================================================================
  init-pool1:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/init-pool-node.sh", "1"]
    environment:
      <<: [*common-env, *pool-ips]
    volumes:
      - pool1-data:/data
      - genesis-shared:/shared-genesis
      - logs:/logs
    networks:
      - leios-net

  init-pool2:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/init-pool-node.sh", "2"]
    depends_on:
      init-pool1:
        condition: service_completed_successfully
    environment:
      <<: [*common-env, *pool-ips]
    volumes:
      - pool2-data:/data
      - genesis-shared:/shared-genesis
      - logs:/logs
    networks:
      - leios-net

  init-pool3:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/init-pool-node.sh", "3"]
    depends_on:
      init-pool1:
        condition: service_completed_successfully
    environment:
      <<: [*common-env, *pool-ips]
    volumes:
      - pool3-data:/data
      - genesis-shared:/shared-genesis
      - logs:/logs
    networks:
      - leios-net

  # ==========================================================================
  # Proto-Devnet: Block Producer Nodes (3 pools in mesh topology)
  # ==========================================================================
  pool1:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/run-pool-node.sh", "pool1"]
    depends_on:
      init-pool1:
        condition: service_completed_successfully
    cap_add:
      - NET_ADMIN
    environment:
      <<: *common-env
      PORT: "3001"
    volumes:
      - pool1-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.10
    healthcheck:
      test: ["CMD", "test", "-S", "/data/socket"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  pool2:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/run-pool-node.sh", "pool2"]
    depends_on:
      init-pool2:
        condition: service_completed_successfully
      pool1:
        condition: service_started
    cap_add:
      - NET_ADMIN
    environment:
      <<: *common-env
      PORT: "3002"
    volumes:
      - pool2-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.20
    healthcheck:
      test: ["CMD", "test", "-S", "/data/socket"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  pool3:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/run-pool-node.sh", "pool3"]
    depends_on:
      init-pool3:
        condition: service_completed_successfully
      pool1:
        condition: service_started
    cap_add:
      - NET_ADMIN
    environment:
      <<: *common-env
      PORT: "3003"
    volumes:
      - pool3-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.30
    healthcheck:
      test: ["CMD", "test", "-S", "/data/socket"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  # ==========================================================================
  # Proto-Devnet: TX Generator
  # ==========================================================================
  tx-generator:
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-bp:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node-bp
    command: ["/app/scripts/run-tx-generator.sh"]
    depends_on:
      pool1:
        condition: service_healthy
      pool2:
        condition: service_healthy
      pool3:
        condition: service_healthy
    environment:
      <<: *pool-ips
    volumes:
      - txgen-data:/data
      - genesis-shared:/shared-genesis:ro
      - logs:/logs
    networks:
      - leios-net

  # ==========================================================================
  # Proto-Devnet: Analysis Container
  # ==========================================================================
  analysis:
    image: ghcr.io/input-output-hk/ouroboros-leios/leios-analysis:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.analysis
    depends_on:
      pool1:
        condition: service_healthy
      pool2:
        condition: service_healthy
      pool3:
        condition: service_healthy
    environment:
      <<: *common-env
      PRAOS_LATENCY_THRESHOLD_MS: ${PRAOS_LATENCY_THRESHOLD_MS:-5000}
      CHECK_INTERVAL_SECONDS: ${CHECK_INTERVAL_SECONDS:-5}
      INITIAL_WAIT_SECONDS: ${INITIAL_WAIT_SECONDS:-30}
    volumes:
      - logs:/logs:ro
    networks:
      - leios-net

  # ==========================================================================
  # ImmDB Profile: Init Containers (use --profile immdb)
  # ==========================================================================
  init-upstream:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/immdb-server:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.immdb-server
    command: /app/scripts/init-upstream.sh
    environment:
      <<: *common-env
    volumes:
      - upstream-data:/data
      - logs:/logs
    networks:
      - leios-net

  init-node0:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-leios:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node
    command: /app/scripts/init-node0.sh
    environment:
      <<: *common-env
      IP_UPSTREAM_NODE: "172.28.0.110"
      PORT_UPSTREAM_NODE: "3001"
    volumes:
      - node0-data:/data
      - logs:/logs
    networks:
      - leios-net

  init-downstream:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-leios:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node
    command: /app/scripts/init-downstream.sh
    environment:
      <<: *common-env
      IP_NODE0: "172.28.0.120"
      PORT_NODE0: "3002"
    volumes:
      - downstream-data:/data
      - logs:/logs
    networks:
      - leios-net

  # ==========================================================================
  # ImmDB Profile: Main Services (use --profile immdb)
  # ==========================================================================
  upstream:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/immdb-server:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.immdb-server
    command: /app/scripts/run-upstream.sh
    depends_on:
      init-upstream:
        condition: service_completed_successfully
    cap_add:
      - NET_ADMIN
    environment:
      <<: [*common-env, *wan-env-upstream]
      PORT: "3001"
      ONSET_OF_REF_SLOT: ${ONSET_OF_REF_SLOT:-}
    volumes:
      - upstream-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.110
    healthcheck:
      test: ["CMD", "test", "-f", "/data/schedule.json"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  node0:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-leios:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node
    command: ["/app/scripts/run-cardano-node.sh", "node0"]
    depends_on:
      init-node0:
        condition: service_completed_successfully
      upstream:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
    environment:
      <<: [*common-env, *wan-env-node0-up]
      PORT: "3002"
    volumes:
      - node0-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.120
    healthcheck:
      test: ["CMD", "test", "-S", "/data/socket"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  downstream:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/cardano-node-leios:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.cardano-node
    command: ["/app/scripts/run-cardano-node.sh", "downstream"]
    depends_on:
      init-downstream:
        condition: service_completed_successfully
      node0:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
    environment:
      <<: [*common-env, *wan-env-downstream]
      PORT: "3003"
    volumes:
      - downstream-data:/data
      - logs:/logs
    networks:
      leios-net:
        ipv4_address: 172.28.0.130
    healthcheck:
      test: ["CMD", "test", "-S", "/data/socket"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 30s

  # ==========================================================================
  # ImmDB Profile: Analysis Container (use --profile immdb)
  # ==========================================================================
  analysis-immdb:
    profiles: ["immdb"]
    image: ghcr.io/input-output-hk/ouroboros-leios/leios-analysis:${GIT_SHA:-latest}
    build:
      context: ..
      dockerfile: antithesis/Dockerfile.analysis
    depends_on:
      upstream:
        condition: service_healthy
      node0:
        condition: service_healthy
      downstream:
        condition: service_healthy
    environment:
      <<: *common-env
      PRAOS_LATENCY_THRESHOLD_MS: ${PRAOS_LATENCY_THRESHOLD_MS:-5000}
      CHECK_INTERVAL_SECONDS: ${CHECK_INTERVAL_SECONDS:-5}
      INITIAL_WAIT_SECONDS: ${INITIAL_WAIT_SECONDS:-30}
    volumes:
      - logs:/logs:ro
    networks:
      - leios-net

  # ==========================================================================
  # Observability Stack (use --profile observability)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest
    profiles: ["observability"]
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - leios-net

  loki:
    image: grafana/loki:latest
    profiles: ["observability"]
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./config/loki.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    networks:
      - leios-net

  alloy:
    image: grafana/alloy:latest
    profiles: ["observability"]
    command:
      - run
      - /etc/alloy/config.river
    volumes:
      - ./config/alloy.river:/etc/alloy/config.river:ro
      - logs:/logs:ro
    depends_on:
      - loki
    networks:
      - leios-net

  grafana:
    image: grafana/grafana:latest
    profiles: ["observability"]
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
    networks:
      - leios-net

volumes:
  # Proto-devnet volumes
  pool1-data:
  pool2-data:
  pool3-data:
  txgen-data:
  genesis-shared:
  # ImmDB profile volumes
  upstream-data:
  node0-data:
  downstream-data:
  # Shared volumes
  logs:
  prometheus-data:
  loki-data:
  grafana-data:

networks:
  leios-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
