<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1500" viewBox="0 0 1200 1500">
  <style>
    .actor-label { font: 14px sans-serif; text-anchor: middle; }
    .timeline { stroke-width: 2; }
    .interaction { stroke-width: 2; }
    .self-interaction { fill: white; stroke-width: 2; }
    .label { font: 12px sans-serif; text-anchor: middle; }
    .legend { font: 12px sans-serif; }
  </style>

  <!-- Actors -->
  <rect x="50" y="20" width="150" height="40" fill="#B0E2FF" stroke="#6A9BC7" />
  <text x="125" y="45" class="actor-label">Block Producer</text>
  <rect x="350" y="20" width="150" height="40" fill="#FFE4C4" stroke="#D4A76A" />
  <text x="425" y="45" class="actor-label">Voting Node</text>
  <rect x="650" y="20" width="150" height="40" fill="#f5f5f5" stroke="#dedede" />
  <text x="725" y="45" class="actor-label">Network Peers</text>
  <rect x="950" y="20" width="150" height="40" fill="#B0E2FF" stroke="#6A9BC7" />
  <text x="1025" y="45" class="actor-label">Next Producer</text>

  <!-- Timelines -->
  <line x1="125" y1="60" x2="125" y2="1350" class="timeline" stroke="#6A9BC7" stroke-dasharray="5,5" />
  <line x1="425" y1="60" x2="425" y2="1350" class="timeline" stroke="#D4A76A" stroke-dasharray="5,5" />
  <line x1="725" y1="60" x2="725" y2="1350" class="timeline" stroke="#dedede" stroke-dasharray="5,5" />
  <line x1="1025" y1="60" x2="1025" y2="1350" class="timeline" stroke="#6A9BC7" stroke-dasharray="5,5" />

  <!-- Step 1a: Block creation (self-interaction) -->
  <rect x="25" y="80" width="200" height="60" class="self-interaction" stroke="#6A9BC7" stroke-dasharray="5,5" />
  <text x="125" y="110" class="label">
    <tspan x="125" dy="-7.5">1a: OnRBCreate</tspan>
    <tspan x="125" dy="15">(create RB+EB)</tspan>
  </text>

  <!-- Step 1b: Header diffusion -->
  <line x1="125" y1="180" x2="425" y2="180" class="interaction" stroke="#ff6b6b" marker-end="url(#arrow-rbheader)" />
  <text x="275" y="150" class="label">
    <tspan x="275" dy="0">1b: RbHeaderRelay</tspan>
    <tspan x="275" dy="15">(diffuse header)</tspan>
  </text>
  <line x1="125" y1="230" x2="725" y2="230" class="interaction" stroke="#ff6b6b" marker-end="url(#arrow-rbheader)" />
  <text x="425" y="200" class="label">
    <tspan x="425" dy="0">1b: RbHeaderRelay</tspan>
    <tspan x="425" dy="15">(diffuse header)</tspan>
  </text>
  <line x1="125" y1="280" x2="1025" y2="280" class="interaction" stroke="#ff6b6b" marker-end="url(#arrow-rbheader)" />
  <text x="575" y="250" class="label">
    <tspan x="575" dy="0">1b: RbHeaderRelay</tspan>
    <tspan x="575" dy="15">(diffuse header)</tspan>
  </text>

  <!-- Step 2a: Header processing (self-interactions) -->
  <rect x="325" y="330" width="200" height="60" class="self-interaction" stroke="#666666" stroke-dasharray="5,5" />
  <text x="425" y="364" class="label">
    <tspan x="425" dy="-7.5">2a: OnRBHeaderReceived</tspan>
    <tspan x="425" dy="15">(detect equivocation)</tspan>
  </text>
  <rect x="625" y="380" width="200" height="60" class="self-interaction" stroke="#666666" stroke-dasharray="5,5" />
  <text x="725" y="414" class="label">
    <tspan x="725" dy="-7.5">2a: OnRBHeaderReceived</tspan>
    <tspan x="725" dy="15">(process header)</tspan>
  </text>
  <rect x="925" y="430" width="200" height="60" class="self-interaction" stroke="#666666" stroke-dasharray="5,5" />
  <text x="1025" y="464" class="label">
    <tspan x="1025" dy="-7.5">2a: OnRBHeaderReceived</tspan>
    <tspan x="1025" dy="15">(process header)</tspan>
  </text>

  <!-- Step 2b: EB content requests -->
  <line x1="425" y1="500" x2="125" y2="500" class="interaction" stroke="#4dabf7" marker-end="url(#arrow-ebrelay)" />
  <text x="275" y="470" class="label">
    <tspan x="275" dy="0">2b: EbRelay/EbFetch</tspan>
    <tspan x="275" dy="15">(request EB content)</tspan>
  </text>
  <line x1="725" y1="550" x2="125" y2="550" class="interaction" stroke="#4dabf7" marker-end="url(#arrow-ebrelay)" />
  <text x="425" y="520" class="label">
    <tspan x="425" dy="0">2b: EbRelay/EbFetch</tspan>
    <tspan x="425" dy="15">(request EB content)</tspan>
  </text>
  <line x1="1025" y1="600" x2="125" y2="600" class="interaction" stroke="#4dabf7" marker-end="url(#arrow-ebrelay)" />
  <text x="575" y="570" class="label">
    <tspan x="575" dy="0">2b: EbRelay/EbFetch</tspan>
    <tspan x="575" dy="15">(request EB content)</tspan>
  </text>

  <!-- Step 2c: EB content responses -->
  <line x1="125" y1="650" x2="425" y2="650" class="interaction" stroke="#4dabf7" stroke-dasharray="5,5" marker-end="url(#arrow-ebrelay)" />
  <text x="275" y="620" class="label">
    <tspan x="275" dy="0">2c: EB content</tspan>
    <tspan x="275" dy="15">(OnEBContentReceived)</tspan>
  </text>
  <line x1="125" y1="700" x2="725" y2="700" class="interaction" stroke="#4dabf7" stroke-dasharray="5,5" marker-end="url(#arrow-ebrelay)" />
  <text x="425" y="670" class="label">
    <tspan x="425" dy="0">2c: EB content</tspan>
  </text>
  <line x1="125" y1="750" x2="1025" y2="750" class="interaction" stroke="#4dabf7" stroke-dasharray="5,5" marker-end="url(#arrow-ebrelay)" />
  <text x="575" y="720" class="label">
    <tspan x="575" dy="0">2c: EB content</tspan>
  </text>

  <!-- Step 3a: Transaction fetch request -->
  <line x1="425" y1="800" x2="125" y2="800" class="interaction" stroke="#51cf66" marker-end="url(#arrow-txfetch)" />
  <text x="275" y="770" class="label">
    <tspan x="275" dy="0">3a: TxFetch</tspan>
    <tspan x="275" dy="15">(request missing txs - if needed)</tspan>
  </text>

  <!-- Step 3b: Transaction response -->
  <line x1="125" y1="850" x2="425" y2="850" class="interaction" stroke="#51cf66" stroke-dasharray="5,5" marker-end="url(#arrow-txfetch)" />
  <text x="275" y="820" class="label">
    <tspan x="275" dy="0">3b: Missing transactions</tspan>
    <tspan x="275" dy="15">(OnMissingEBContent)</tspan>
  </text>

  <!-- Step 4a: EB validation (self-interaction) -->
  <rect x="325" y="900" width="200" height="60" class="self-interaction" stroke="#D4A76A" stroke-dasharray="5,5" />
  <text x="425" y="936" class="label">
    <tspan x="425" dy="-7.5">4a: OnEBValidationComplete</tspan>
    <tspan x="425" dy="15">(validate &amp; vote decision)</tspan>
  </text>

  <!-- Step 4b: Vote diffusion -->
  <line x1="425" y1="970" x2="1025" y2="970" class="interaction" stroke="#ffd43b" marker-end="url(#arrow-voterelay)" />
  <text x="725" y="940" class="label">
    <tspan x="725" dy="0">4b: VoteRelay</tspan>
    <tspan x="725" dy="15">(diffuse vote)</tspan>
  </text>
  <line x1="425" y1="1020" x2="725" y2="1020" class="label">
    <text x="575" y="990" class="label">
      <tspan x="575" dy="0">4b: VoteRelay</tspan>
      <tspan x="575" dy="15">(diffuse vote)</tspan>
    </text>
  </line>

  <!-- Step 5: Vote aggregation (self-interaction) -->
  <rect x="975" y="1070" width="200" height="50" class="self-interaction" stroke="#fa5252" stroke-dasharray="5,5"></rect>
  <text x="1075" y="1100" class="label">
    <tspan x="1075" dy="-7.5">5: OnVoteReceived</tspan>
    <tspan x="1075" dy="15">(aggregate votes, create cert)</tspan>
  </text>

  <!-- Step 6a: Next block creation (self-interaction) -->
  <rect x="975" y="1130" width="200" height="40" class="self-interaction" stroke="#6A9BC7" stroke-dasharray="5,5"></rect>
  <text x="1075" y="1155" class="label">
    <tspan x="1075" dy="-7.5">6a: OnRBCreate</tspan>
    <tspan x="1075" dy="15">(include certificate)</tspan>
  </text>

  <!-- Step 6b: New block diffusion -->
  <line x1="1025" y1="1180" x2="425" y2="1180" class="interaction" stroke="#845ef7" marker-end="url(#arrow-chainsync)" />
  <text x="725" y="1150" class="label">
    <tspan x="725" dy="0">6b: ChainSync</tspan>
    <tspan x="725" dy="15">(new RB + certificate)</tspan>
  </text>
  <line x1="1025" y1="1230" x2="725" y2="1230" class="interaction" stroke="#845ef7" marker-end="url(#arrow-chainsync)" />
  <text x="875" y="1200" class="label">
    <tspan x="875" dy="0">6b: ChainSync</tspan>
    <tspan x="875" dy="15">(new RB + certificate)</tspan>
  </text>

  <!-- Step 7: Peer relaying -->
  <line x1="725" y1="1280" x2="425" y2="1280" class="interaction" stroke="#ff6b6b" stroke-dasharray="5,5" marker-end="url(#arrow-rbheader)" />
  <text x="575" y="1250" class="label">
    <tspan x="575" dy="0">7: RbHeaderRelay</tspan>
    <tspan x="575" dy="15">(relay to peers)</tspan>
  </text>

  <!-- Legend -->
  <rect x="400" y="1370" width="525" height="60" fill="white" stroke="#000000" stroke-width="1" />
  <text x="687.5" y="1390" class="legend" text-anchor="middle" style="font-weight: bold;font-size: 14px;">Mini-Protocols</text>
  <!-- Evenly spaced: 5 items, box width 575, left x=400, right x=975, add whitespace between items -->
  <circle cx="440" cy="1410" r="5" fill="#ff6b6b" />
  <text x="448" y="1415" class="legend">RbHeaderRelay</text>
  <circle cx="545" cy="1410" r="5" fill="#4dabf7" />
  <text x="553" y="1415" class="legend">EbRelay/EbFetch</text>
  <circle cx="660" cy="1410" r="5" fill="#51cf66" />
  <text x="668" y="1415" class="legend">TxFetch</text>
  <circle cx="725" cy="1410" r="5" fill="#ffd43b" />
  <text x="733" y="1415" class="legend">VoteRelay</text>
  <circle cx="800" cy="1410" r="5" fill="#845ef7" />
  <text x="808" y="1415" class="legend">ChainSync</text>

  <!-- Arrow definitions -->
  <defs>
    <marker id="arrow-rbheader" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L6,3 z" fill="#ff6b6b" />
    </marker>
    <marker id="arrow-ebrelay" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L6,3 z" fill="#4dabf7" />
    </marker>
    <marker id="arrow-txfetch" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L6,3 z" fill="#51cf66" />
    </marker>
    <marker id="arrow-voterelay" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L6,3 z" fill="#ffd43b" />
    </marker>
    <marker id="arrow-chainsync" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L6,3 z" fill="#845ef7" />
    </marker>
  </defs>
</svg>